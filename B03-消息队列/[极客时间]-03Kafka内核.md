> 来源：极客时间《Kafka核心技术与实战》

# 23 | Kafka副本机制详解

所谓的副本机制（Replication），通常是指分布式系统在多台网络互联的机器上保存有相同的数据拷贝。副本机制有什么好处呢？

- 提供数据冗余：增加系统整体的可用性。
- 提供高伸缩性：能够通过增加机器的方式来提升读性能，进而提高读操作吞吐量。
- 改善数据局部性：允许将数据放入与用户地理位置相近的地方，从而降低系统延时。

然而对于 Apache Kafka 而言，目前只能享受到副本机制带来的第 1 个好处。即便如此，副本机制依然是 Kafka 设计架构的核心所在，它也是 Kafka 确保系统高可用和消息高持久性的重要基石。

**副本定义**

所谓副本（Replica），本质就是一个只能追加写消息的提交日志。同一个分区下的所有副本保存有相同的消息序列，这些副本分散保存在不同的 Broker 上，从而能够对抗部分 Broker 宕机带来的数据不可用。

> 在实际生产环境中，每台 Broker 都可能保存有各个主题下不同分区的不同副本，因此，单个 Broker 上存有成百上千个副本的现象是非常正常的。

接下来我们来看一张图，它展示的是一个有 3 台 Broker 的 Kafka 集群上的副本分布情况。

![image-20210715225817802](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210715225817.png)

从这张图中，我们可以看到，主题 1 分区 0 的 3 个副本分散在 3 台 Broker 上，其他主题分区的副本也都散落在不同的 Broker 上，从而实现数据冗余。

**副本角色**

我们该如何确保副本中所有的数据都是一致的呢？

Apache Kafka 采用了基于领导者（Leader-based）的副本机制，工作原理如下图所示：

![image-20210715230922759](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210715230922.png)

对于上图，有几点信息需要明确：

第一，每个分区在创建时都要选举一个副本作为领导者副本，其余的副本则为追随者副本。

第二，在 Kafka 中，追随者副本是不对外提供服务的，所有的请求都必须由领导者副本来处理。

第三，当领导者副本所在的 Broker 宕机时，会立即开启新一轮的领导者选举。

追随者副本不对外提供，Kafka 为什么要这样设计呢？

第一，方便实现 “Read-your-writes”。当你使用生产者 API 向 Kafka 成功写入消息后，可以马上使用消费者 API 去读取刚才生产的消息。

第二，方便实现单调读（Monotonic Reads）。对于一个消费者用户而言，在多次消费消息时，它不会看到某条消息一会儿存在一会儿不存在。

**In-sync Replicas（ISR）**

怎么度量追随者副本与 Leader 不同步呢？

Kafka 引入了 In-sync Replicas，即 ISR 副本集合。ISR 中的副本都是与 Leader 同步的副本，相反，不在 ISR 中的追随者副本就被认为是与 Leader 不同步的。

> Leader 副本天然就在 ISR 中。也就是说，ISR 不只是追随者副本集合，它必然包括 Leader 副本。甚至在某些情况下，ISR 只有 Leader 这一个副本。

能够进入到 ISR 的追随者副本要满足一定的标准，这个标准就是 Broker 端参数 replica.lag.time.max.ms 参数值。这个参数的含义是 Follower 副本能够落后 Leader 副本的最长时间间隔，当前默认值是 10 秒。

> 只要一个 Follower 副本落后 Leader 副本的时间不连续超过 10 秒，那么 Kafka 就认为该 Follower 副本与 Leader 是同步的，即使此时 Follower 副本中保存的消息明显少于 Leader 副本中的消息。

**Unclean Leader Election**

当出现 ISR 为空，就说明 Leader 副本也“挂掉”了，Kafka 需要从非同步副本中选举一个新的 Leader，选举这种副本的过程称为 Unclean 领导者选举。

通常来说，非同步副本（ISR 集合外的副本）落后 Leader 太多，如果选择这些副本作为新 Leader，就可能出现数据的丢失。Broker 端可通过参数 unclean.leader.election.enable 控制是否允许 Unclean 领导者选举。

开启 Unclean 领导者选举可能会造成数据丢失，但好处是，它使得分区 Leader 副本一直存在，不至于停止对外提供服务，因此提升了高可用性。

反之，禁止 Unclean 领导者选举的好处在于维护了数据的一致性，避免了消息丢失，但牺牲了高可用性。

Kafka 赋予了你选择 C 或 A 的权利。我强烈建议你不要开启它，毕竟我们还可以通过其他的方式来提升高可用性。如果为了这点儿高可用性的改善，牺牲了数据一致性，那就非常不值当了。









