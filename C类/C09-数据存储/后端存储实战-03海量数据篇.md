# 15 | MySQL存储海量数据的最后一招：分库分表

解决海量数据的问题，必须要用到分布式的存储集群，因为 MySQL本质上是一个单机数据库，所以很多场景下不是太适合存 TB 级别以上的数据。

但是，绝大部分的电商大厂，它的在线交易这部分的业务，比如说，订单、支付相关的系统，还是舍弃不了 MySQL，原因是，只有 MySQL 这类关系型数据库，才能提供金融级的事务保证。

> 我们之前也讲过分布式事务，那些新的分布式数据库提供的所谓的分布式事务，目前还达不到这些交易类系统对数据一致性的要求。

那既然 MySQL 支持不了这么大的数据量，这么高的并发，还必须要用它，怎么解决这个问题呢？还是按照我上节课跟你说的思想，分片，也就是拆分数据。不过，思路是这样没错，分库分表实践起来是非常不容易的，有很多问题需要去思考和解决。

**分库还是分表？**

什么情况下适合分表，什么情况下不得不分库？那我们分库分表的目的是为了解决两个问题：

第一，是数据量太大查询慢的问题。这里面我们讲的“查询”其实主要是事务中的查询和更新操作，因为只读的查询可以通过缓存和主从分离来解决。解决查询慢，只要减少每次查询的数据总量就可以了，也就是说，分表就可以解决问题。

第二，是为了应对高并发的问题。应对高并发的思想，也就是一个数据库实例撑不住，就把并发请求分散到多个实例中去，所以，解决高并发的问题是需要分库的。

简单地说，数据量大，就分表；并发高，就分库。

**如何选择 Sharding Key？**

选择这个 Sharding Key 最重要的参考因素是，我们的业务是如何访问数据的。

比如我们把订单 ID 作为 Sharding Key 来拆分订单表，那拆分之后，如果我们按照订单 ID 来查订单，就需要先根据订单 ID 和分片算法计算出，我要查的这个订单它在哪个分片上。

> 问题一

但是，当我打开“我的订单”这个页面的时候，它的查询条件是用户 ID，这里没有订单 ID，那就没法知道我们要查的订单在哪个分片上了。这个问题的解决办法是，建一张用户与订单的关系表，这张表使用用户 ID 作为 Sharding Key。

> 问题二

那我们系统对订单的查询方式，肯定不只是按订单 ID 或者按用户 ID 这两种啊。比如说，商家希望看到的是自己店铺的订单，还有各种和订单相关的报表。对于这些查询需求，我们一旦对订单做了分库分表，就没法解决了。那怎么办呢？

一般的做法是，把订单数据同步到其他的存储系统<!--（另一个微服务）-->中去，在其他的存储系统里面解决问题。比如说，我们可以再构建一个以店铺 ID 作为 Sharding Key 的订单库，专门供商家来使用。或者，把订单数据同步到 HDFS 中，然后用一些大数据技术来生成订单相关的报表。

所以你看，一旦做了分库分表，就会极大地限制数据库的查询能力，之前很简单的查询，分库分表之后，可能就没法实现了。所以我们首先要来缓解数据多、并发高的问题。分库分表一定是，数据量和并发大到所有招数都不好使了，我们才拿出来的最后一招。

> 总结一下：
>
> - 性能问题：规避慢 SQL --> 缓存 --> 数据归档
> - 并发问题：读写分离
> - 最后一招：分库分表

**如何选择分片算法？**

> 范围分片

能不能用订单完成时间作为 Sharding Key 呢？比如说，我分 12 个分片，每个月一个分片。

这种做法有个很大的问题，比如现在是 3 月份，那基本上所有的查询都集中在 3 月份这个分片上，其他 11 个分片都闲着，这个问题就是“热点问题”。范围分片特别适合那种数据量非常大，但并发访问量不大的 ToB 系统。

比如说，电信运营商的监控系统，它可能要采集所有人手机的信号质量，然后做一些分析，这个数据量非常大，但是这个系统的使用者是运营商的工作人员，并发量很少。这种情况下就很适合范围分片。

> 哈希分片

一般来说，订单表都采用更均匀的哈希分片算法。比如说，我们要分 24 个分片，选定了 Sharding Key 是用户 ID，那我们决定某个用户的订单应该落到那个分片上的算法是，拿用户 ID 除以 24，得到的余数就是分片号。这是最简单的取模算法，一般就可以满足大部分要求了。当然也有一些更复杂的哈希算法，像一致性哈希之类的，特殊情况下也可以使用。

> 查表法

还有一种分片的方法：查表法。查表法其实就是没有分片算法，决定某个 Sharding Key 落在哪个分片上，全靠人为来分配，分配的结果记录在一张表里面。每次执行查询的时候，先去表里查一下要找的数据在哪个分片中。

但你需要注意的是，分片映射表本身的数据不能太多，否则这个表反而成为热点和性能瓶颈了。查表法相对其他两种分片算法来说，缺点是需要二次查询，实现起来更复杂，性能上，分片映射表可以通过缓存来加速查询，实际性能并不会慢很多。

# 16 | 用Redis构建缓存集群的最佳实践有哪些？

# 17 | 大厂都是怎么做MySQL to Redis同步的?

# 18 | 分布式存储：你知道对象存储是如何保存图片文件的吗？



# 19 | 跨系统实时同步数据，分布式事务是唯一的解决方案吗？

# 20 | 如何在不停机的情况下，安全地更换数据库？

# 21 | 类似“点击流”这样的海量数据应该如何存储？

# 22 | 面对海量数据，如何才能查得更快?

# 23 | MySQL经常遇到的高可用、分片问题，NewSQL是如何解决的？

# 24 | RocksDB：不丢数据的高性能KV存储



