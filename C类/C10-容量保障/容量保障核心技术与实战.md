# 开篇词 | 互联网时代，人人肩负容量保障的职责

在我的职业生涯中，能够非常深刻地感受到，容量保障对于一家互联网公司的重要性，因为几乎每时每刻我都在回答这些问题：

- 我负责的软件系统目前运行的很好，但是公司业务增长迅猛，如果访问量增加 2 倍，系统还能支撑吗？
- 如果无法支撑 2 倍的访问量，哪些服务会首先成为瓶颈？
- 这些服务如果采取扩容措施，需要扩容多少量？
- 大规模促销活动场景下，容量风险如何识别和预防？

我在多个场合进行容量保障分享时，也经常被问及这样的问题：

- 我们一直在做性能测试，为啥服务容量还是老出问题？
- 容量保障，有没有套路可循？
- 我们公司规模不大，没有专人去做容量保障，有没有成本低点的办法？
- 我公司规模不大，业务也没有什么大促场景，需要做容量保障吗？

**到底什么是容量保障?**

容量保障，就是用各种方法保证软件系统的容量充足，预防容量隐患的重要工作。

容量保障对于系统稳定性至关重要，如果一辆货车核载 80 吨，而我们塞进了 100 吨的货物，后果可想而知。

**容量保障难不难？**

互联网场景下的容量保障工作是一项系统性工程，它的难点主要体现在以下几个方面。

1. 容量的不确定性：一辆货车在交付时已经标注了核载重量，而互联网服务的容量受服务器资源、架构设计、网络传输状况和业务场景等多种条件制约，会呈现出不同的容量表现，很难得到确定解。
2. 容量评估的复杂性：随着微服务架构的日益盛行，服务链路变得越来越复杂，任何一个环节出现容量瓶颈都有可能放大到整条链路，这给容量评估工作带来了难度。
3. 容量测试的不准确性：容量测试的场景需要尽可能逼近真实情况，还需要保证被测服务的环境（服务资源、规模、配置等）与真实环境对等，但实际上受制于各种原因，我们很难做到完全仿真，因此容量测量的准确性也是一个挑战。
4. 此外，容量保障还会牵扯到成本管理的问题，这也是一个难点。

说了那么多难点，那么如何将它们变得不难呢？这就是我的这个专栏希望带给你的价值。

**课程是如何设计的?**

在这次的专栏中，我将从技术视角出发构建一个容量保障体系化的大图，覆盖容量保障工作的方方面面，逐个击破，尽可能全面地展现容量保障各项技术的全貌。具体来说，会有以下三个部分。

基础篇：我将以容量保障工作的时间轴为主线，分别就目标、测量、分析、治理这几大工作展开，积累容量保障的通用方法，帮助你完成基础入门。

进阶篇：我将分几个独立专项话题，对容量保障工作中的一些前沿技术进行深入剖析，包括全链路压测、分布式压测平台的研发工作，以及 AI 预测容量、云原生下的容量保障新趋势等。这其中部分话题在业界甚至是第一次公开，非常值得学习。

案例篇：从案例场景出发，介绍双 11 大促场景下的容量保障工作如何做好，及小公司如何建立容量保障体系，并对容量保障组织建设给出我的建议。

在这里，我先为你总结一套较为适合互联网场景的容量保障方法论，如下图所示。

![image-20241104231431875](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202411042314907.png)

先从“日常容量”和“大促容量”的目标出发，拆分出三个入口：

- 计划事件：事先能够预知的新功能或大促活动
- 突发事件：事先无法预知的紧急事件
- 日常事件：常态化的容量表现

再自上而下拆解出具体的策略（工作项、工具、规范、案例等），每一项策略再做具体细分，形成一个有机的整体。

当然，这套方法论未必适合所有的场景和业务形态，但我认为，即便是在一个全新的领域，它也可以帮助你在最短的时间内，建立一套有效的容量保障体系。更重要的是，它提供了一种核心的思维方式。

# ==基础篇==

# 01 | 容量保障的目标：容量保障的目标是什么？该如何度量？

如果我们面对的是企事业单位的某个内部系统，有着非常稳定的用户规模和几乎不变的产品功能，那么容量保障就是基于固定用户量的一次性保障工作。相反，如果是大型电商系统，业务场景有明显的流量峰值，且经常举办大促活动，容量保障就是一部“跌宕起伏的连续剧”。

**容量保障的目标是什么？**

总结一下其实就两句话：

- 第一，容量规划。以尽可能小的成本确保系统当前和未来的容量充足；
- 第二，容量治理。解决已知的容量问题，预防未知的容量问题。

在控制成本的基础上，我们要保障服务容量充足，即服务的各项资源消耗和业务指标保持在一个相对安全的范围内，这个范围可以是推算出来的，也可以是通过容量测试验证出来的，亦可以是真实流量体现出来的，我们将其称之为“安全水位”。

分布式系统中充满了不确定性，网络可能抖三抖，硬盘可能崩一崩，我们一方面要尽可能在这种不可靠的环境下预防容量问题的发生，又要在出现容量问题时，有能力在短时间内消除影响，甚至是全自动的进行止损，这一点直接影响着服务可用性和用户体验。

**容量保障目标的量化**

如果公司将容量保障的任务交给你来完成，你怎么证明自己的工作完成得好不好呢？这时候，你就需要去量化目标，用数据说话。

那么，容量保障工作中有哪些关键的量化指标呢？

1、服务等级协议（SLA）

通俗地说，SLA 就是对服务可用性的一个保证。

举个具体的例子，我们要求系统整体可用性 SLA 为 4 个 9（99.99%），即每年不可用时长≤52.56 分钟。基于这个整体 SLA 要求，并综合考虑历年容量问题对服务可用性的影响比例（比如占比为1/5），最终设定容量问题造成的可用性损失不高于 10 分钟（52.26 / 5≈10 分钟），这就是一个明确的目标，基于这个目标拆解策略是可衡量的。

再比如，我们将交易链路下单接口的成功率≥95% 作为 SLA 的一部分，并且承诺低于该成功率的时长不超过 1 分钟，这就是一个容易理解且可测量的 SLA，通过对下单接口的监控就可以观测。交易链路的容量问题有导致下单成功率下跌的可能性，因此作为容量保障的目标也是合理的。

![image-20241105231650520](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202411052316639.png)

2、QPS/TPS

QPS（Queries per Second）指的是每秒查询率，是一台服务器每秒能够响应的查询次数，即 1 秒内完成的请求数量，一般针对读请求居多。

TPS（Transactions per Second）指的是每秒处理的事务数，一般针对写请求居多。

QPS/TPS 是容量保障目标中最常见的指标，我们通常说“系统容量是否足够”，一般就是指系统或服务能否在可接受的响应时间和成功率下支撑目标 QPS/TPS。

3、用户体验

第三个关键指标是用户体验。有些容量问题尽管没有影响可用性，但会导致用户操作时响应延迟，页面打开缓慢等体验问题。

不过，用户体验问题的定性是相对困难的，一种手段是将客户投诉或内测版本反馈作为一个维度去跟踪。另外，绝大多数用户体验是可以与系统指标或业务指标挂钩的，这些指标就可以作为目标的一部分。比如，有用户反馈某个操作等待时间特别长，其涉及的接口背后的服务器 CPU 利用率、内存利用率、响应时间、调用的消息队列延迟等信息，就都可以作为参考维度。

# 02 | 容量测试与验证：怎样科学实施容量测试？



# 03 | 容量指标分析经典5问：响应时间真的是越短越好吗？



# 04 | 容量治理的三板斧：扩容、限流与降级

















