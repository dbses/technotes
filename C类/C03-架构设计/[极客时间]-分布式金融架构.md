> 来源极客时间《分布式金融架构课》

# 开篇词 | 如何成为金融级人才？

军用软件的复杂度在于需要实时处理武器信号，操作系统的复杂度在于需要在功能的多样性和效率之间做一个良好的平衡，而金融软件的复杂度在于如何在软件系统的演进过程中保持并证明系统的正确性。

那到底什么是金融级软件呢？

首先，我们得知道金融软件要解决的核心问题是什么？没错，就是钱！钱一旦处理错了，那可就是真金白银的损失，所以任何一家金融机构对系统错误都是零容忍的。这样的特殊性，使得金融级软件系统区别于很多其它的大型软件系统，它对正确性以及速度都提出了更高的要求。

那面对这样的金融级软件，金融级人才又需要怎样的能力呢？

假如你现在是一个金融系统的负责人，你需要在系统正确性和吞吐量之间做个选择。很显然你会毫不犹豫地选择正确性。但是如果有人告诉你，系统吞吐量出现了问题，用户可能就转不了钱了，这样会造成恶意挤兑，从而形成恶性群体性事件。那么你又该如何选择呢？你很有可能会进退维谷，在两难之间犹豫。

其实这个例子就反映了我们对金融软件质量的要求。衡量软件质量有很多种不同角度，一般的软件我们会选择在矛盾中取舍，但是金融软件则要求我们尽可能在所有的地方都做到最好。这种在矛盾中同时追求极致的要求，就是对金融级人才最大的挑战。这也是你进阶资深架构师乃至公司技术决策者的必经之路。

**这门课是怎么设计的？**

我是从对事和对人这两个角度来设计课程的。

对事的角度比较简单。我希望你能在学完所有课程之后，对金融行业需要怎样的系统建立一个比较全面的认识，知道系统里都包括哪些重要组成部分，以及每个部分的技术挑战点在哪里，常见的技术解决方案都有哪些。最重要的是，你会掌握金融软件架构的整体思路，知道都有可能出现哪些矛盾，以及出现这些矛盾的时候你都有哪些选择。

对人的角度比较困难，也是我个人的一些期许。在这短短的二十多讲里，我会带你初步了解金融业务为什么会有这么多分类，金融软件究竟解决的是什么业务问题，金融软件系统是怎么一步步发展到现在这个样子的。还有最重要的一点，我会为你剖析上述问题的本质究竟是什么。

为了帮助你循序渐进地学习，我把这个专栏分为 3 大部分。

第一部分，金融与业务系统。

这部分我们将围绕常见的金融业务生态及其系统架构需求进行讲解，重点包括第三方支付、交易所、券商、银行和投资银行等等。搞懂了这些金融机构和业务的特点，我们还要总结共性和技术逻辑，给你分析如何利用领域驱动设计的思想来更好地解决金融软件的复杂度问题。

第二部分，系统的正确性保障。

了解了金融业务以后，我们就可以对金融软件质量提出要求了。这部分我们重点学习如何保证金融系统架构的正确性，具体包括业务处理的正确性以及数据处理的正确性，它们是金融系统的必选项。最后，我还会讲到系统优化，让你在保证系统高正确性的同时，也能合理追求速度。

第三部分，分布式正确性及高可用。

针对复杂系统一定是重在实践的，所以这部分我会以分布式系统环境为背景，重点讨论分布式一致性的存在条件、分布式共识算法、分布式的事件溯源架构、分布式数据方案的设计原理以及数据系统的实时动态分库等等。

这部分的每节课都是线上环境中会遇到的关键问题。学习难度逐渐升级，结合实际案例，寻找问题本质，落地前面所学。另外，我还会分享一个金融领域绕不开的话题——容灾，重点讲解跨机房实时容灾以及如何提高系统稳定性。

![image-20250212222717967](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502122227690.png)

# ==第一部分，金融业务与系统 (6讲)==

# 01 | 业务初探：扫了二维码之后发生了什么？

![image-20250212222717967](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502122227690.png)

**情景假设**

扫码支付其实也分很多场景，我选择了与跨境电商相关的扫码跨境支付场景，具体的假设有这些：

1. 付款方用户支付的是人民币。
2. 付款方的借记卡是国内银行 A 发行的，简称买家开户行。
3. 第三方支付公司的备付金账户在国内银行 B，简称第三方开户行。
4. 收款方接受的是美元。
5. 收款方的借记卡是国外银行 C 发行的，简称卖家开户行。
6. 第三方公司是通过银行 D 进行外币兑换业务，简称汇兑提供行。

那么接下来，我会分 4 个部分给你讲解整个支付过程：用户扫码支付、第三方公司进行本币代收、外汇交易以及外币代付。

**用户扫码**

从终端用户的角度来看，扫码由鉴权、支付和拉取状态三个步骤组成。接下来，我们就来详细看看这几个步骤。

- 鉴权

扫码支付最终会用买家的银行卡进行支付。在你开始扫码支付之前，第三方公司需要核实你是否有这张卡的使用权，俗称“绑卡”。

我们可以把鉴权的过程分为 4 步：第 1 步，用户填写【姓名/身份证号/银行卡号】和手机号码；第 2 步，银行发短信验证码给用户手机号；第 3 步，用户将【姓名/身份证号/银行卡号】和短信验证码发给第三方支付公司；第 4 步，第三方支付公司再将所有信息发送给银行进行确认。

在用户绑卡通过之后，银行会返回给第三方支付公司这个用户的内部 ID 信息（也叫 Token）。之后第三方支付公司就可以拿这个 ID 进行所有合法的操作。

刚才给你讲解的流程示意图如下：

![image-20250213230805936](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502132308022.png)

- 支付

为了应对用户操作的峰值情况，金融机构普遍通过异步消息处理的架构来对极端流量进行削峰填谷。如果流量突然增大，异步消息架构会缓存所有请求，慢慢处理。异步消息架构的结果就是用户不会及时得到处理结果，需要自己不断地去查询处理情况。

当银行处理完支付后，银行会把支付成功的消息推送给用户和第三方支付公司。第三方支付公司也会推送给你支付成功的消息。

![image-20250213231249275](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502132312316.png)

**本币代收**

前面我们假设了这笔支付涉及到外汇交易，由于买家的和卖家使用的币种不同，就无法直接转账。这时候就需要第三方支付公司这个中间人来帮忙了。中间人角色要做 3 件事情：

1. 本币代收
2. 外汇交易
3. 外币代付

通俗一点来说，本币代收就是将你该付的钱先打到第三方支付公司账上。由于第三方支付公司的账号和买家的银行卡在两家不同的银行，本币代收需要进行跨行转账。

- 央行和清算机构

所有银行都在这个新的第三方机构里放足够多的钱，一般叫做==存款准备金==。当两家银行之间需要转账的时候，第三方机构在内部搬运一下就好。

怎么知道转移的金额有多少？银行系统对跨行转账的流程进行了优化。那就是在白天只做记录，不进行任何实质性的跨行转账。等每天结束的时候计算一下两个银行之间交易金额的差额是多少，最后通过央行进行一笔跨行转账就可以了。这种计算交易差额的方式叫做==轧差==。

- 跨行转账流程

第一步，第三方支付公司发送指令给第三方开户行，要求将钱从用户的买家开户行转到第三方开户行。

第二步，第三方支付公司拥有用户在买家开户行的 Token，所以可以合法发起这笔转账。跨行转账流程开始。

第四步，买家开户行记录的结果是对用户的账号进行扣款。扣款结束后用短信的方式通知用户。

第五步，第三方开户行记录的结果是对第三方支付公司的账号进行打款。

第六步，到了晚上，清算机构对白天发生的交易进行盘存，发现有一笔从买家开户行到第三方开户行的跨行转账还没有真正完成。清算机构会将这笔未完成的跨行转账信息发送给央行。

最后一步，央行收到信息之后，将买家开户行在央行的存款准备金调低，并将第三方开户行在央行的存款准备金调高。

![image-20250213232339873](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502132323936.png)

**外汇交易**

外汇交易的过程又是怎样的呢？按照交易量的大小，可以分为 C 端外汇零售业务和 B端外汇批发业务两个部分。

- C 端外汇零售业务

当第三方支付公司完成了用户的本币代扣之后，第三方支付公司账上就有了对应的人民币。接下来的一步是将这些人民币变成美元，这样才能将美元转给国外的卖家。

在这节课的最开始，我假设了第三方支付公司是通过汇兑提供行进行外汇交易的。那么第三方公司需要在汇兑提供行里建两个账号，一个人民币账号和一个美元账号。同时，汇兑提供行内部也需要有对应两个币种的账号，一个对应着人民币资金池，另一个则是美元资金池。

所以，一笔外币的购买涉及到 4 个账号之间的 2 笔支付订单。交易过程的示意图如下：

![image-20250214223657496](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502142236592.png)

讲到这里，我们解决了第三方支付公司美元账户不足的问题，但是它用来购汇的人民币账户一直在往外出钱，总会有枯竭的一天，又该怎么办呢。

所以我们还需要考虑从外部调资金进来。由于第三方支付公司的备付金账户在第三方开户行，因此需要做从第三方开户行到汇兑提供行的跨行转账，示意图如下：

![image-20250214223941698](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502142239197.png)

但是第三方公司在第三方开户行的账户也在一直出钱，我们往上推演一步，就会发现第三方开户行账户也需要有进来资金的渠道。这个是由前面我们提到的本币代收的过程实现的。我们把买家出资的流程补充完整。整个过程的示意图如下：

![image-20250214224054223](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502142240260.png)

- B 端外汇批发业务

外汇市场是按照交易量大小来划分层次的。最底层的是面对终端用户的外汇零售商。这些零售商负责给一般用户提供小额的外汇交易。这些小笔的外汇交易汇集在一起之后，就会形成一笔大的外汇订单，然后继续往上层交易。

和底层的外汇零售商一样，上一层的机构将所有外汇交易汇集在一起之后，形成更大的外汇订单，再往更上一层交易。一直往上汇集这种事情不会永无止境地进行下去。这个流程的尽头是全球最大的外汇做市商，一般是巨型的跨国商业银行。

![image-20250214224832672](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502142249760.png)

# 02 | 原理解读：第三方支付的业务逻辑和系统组件？

![image-20250212222717967](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502122227690.png)

接下来我们先搞懂支付涉及的核心金融原理，然后按照架构由简到难的顺序，逐步学习点券系统、支付系统和第三方支付公司的支付系统。这样你就能理解支付系统是如何遵循核心金融原理，一步一步从简单的几个组件发展到全面的系统架构了。

**信息流与资金流分离**

在支付业务中最核心的概念是信息流与资金流分离。那什么是信息流和资金流呢？用一句话来概括，信息流指的是想象中钱的流转过程，资金流指的是钱的实际流转过程。

**点券系统**

顾名思义，点券系统就是管理点券的系统。因为重点是讲解架构原理，所以在这里对点券业务和系统做一些简化。现在我们假设只有代金券这一种点券，而且你只能使用代金券来购买产品。

假设最开始用户 A 拥有 100 元代金券，用户 B 拥有 10 元代金券。那么在购买后，用户 A 的代金券账号需要减少 10 元的代金券，同时用户 B 的代金券账号需要增加 10 元的代金券。

好了，到目前为止，我们可以看到，支付过程至少需要 3 个系统：

1. 业务系统，负责生成交易订单和支付订单；
2. 支付网关，负责处理支付订单；
3. 账务系统，负责维护用户账户情况。

在用代金券支付完成后，用户可能需要检查自己的代金券余额，以及与代金券相关的账单。所以我们还需要一个查询系统来完成相关的查询。

另外从产品体验角度看，现在的系统还有一点不足：用户 B 并不知道自己账户收到了点券。这时候及时通知用户 B 可能是一个更合适的产品设计。这时还需要一个账户变动的通知系统。通知系统通常采用异步通知的方式。

<img src="https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502152301472.png" alt="image-20250215230101423" style="zoom: 67%;" />

**支付系统**

现实中，绝大多数支付业务场景是资金流和信息流不一致的情况。所以你必须知道，什么样的架构系统，才能处理好信息流与资金流不一致的情况。

假设用户 A 用 10 元钱从用户 B 那里购买一支笔。这次用户 A用银行卡付款，而不是用点券。

和点券系统一样，业务系统还是照例发起一笔支付订单给支付网关：用户 A 将银行卡上的10 元转给用户 B。不同点在于，支付网关在收到这笔支付订单后，需要判断支付系统能否独立完成资产的转移。点券这种内部资产是可以内部解决的，但是银行卡属于用户，是外部资产，支付系统不能自主解决。

所以支付网关还需要实现路由能力，将内部资产和外部资产两种操作，分发给不同的资产处理组件。因此，这里我们还需要增加内部和外部资产管理系统两个组件，如下图所示。

![image-20250215230741675](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502152307717.png)

外部资产管理系统需要对接第三方支付公司来完成银行卡转账业务。这个对接任务通过金融网关来实现。金融网关主要是实现二进制协议的对接，比如证书签名、加解密、协议传输、数据校验等。

需要注意的是，金融网关和第三方支付公司之间走的是异步通讯协议。前面讲过，异步通讯有额外的不确定状态。那架构上应该如何处理呢？异步系统对接时的架构设计原则，需要将同步系统的一次调用拆分成三个步骤：异步调用、轮询和对账。

![image-20250215231403817](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502152314864.png)

**第三方支付系统**

电商公司会通过支付系统将信息流交给第三方支付系统处理。第三方支付系统会将这个信息流再转交给银行处理。在做跨境交易的时候我们甚至还能看到不同国家第三方支付公司之间的彼此合作。

这里我重点讲三点不同，分别是流量支持、资金池和清算系统。

- 系统的流量支持

第三方支付公司有很多家客户，有可能会面临非常大的支付流量。举个例子，比如第三方支付公司负责代发工资或者代缴水电费，一到月底就会面临非常大的流量。

所以第三方支付公司需要有能力处理这种常见的互联网应用高并发问题。比如我们前面提到的异步消息处理，就能削峰填谷，降低峰值流量的压力。

如果流量再高，还可以选择熔断降流等手段来进行服务降级。如果存储能力支撑不了这么高流量，还可以使用各种不同的缓存技术降低查询操作对数据库的压力，或者使用分库分表的方式来进一步降低每个数据库上面的压力。

- 备付金资金池

资金池是一种常见的用户资金管理手段。资金池就是将属于用户的钱都放在一个大的池子里。池子里的钱不分你我，你是将资金池看作一个整体来操作的。但是你还留着一个账本，上面记载了每个人原来在资金池里放了多少钱。这样虽然钱是混在一起，但是账面上是清楚的。

跨行转账需要多家银行之间配合，还可能需要支付一定的跨行交易费用。但是如果第三方支付公司在每家银行都有资金池，就可以直接在两家银行内部完成用户资金和资金池资金之间的操作了。

![image-20250215231930192](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502152319248.png)

- 清结算能力

清结算中心处理的是多家银行之间的跨行转账。当第三方支付公司有了多个资金池之后，这些资金池之间的转账关系其实和跨行转账一样。既然是一样的，那么第三方支付公司有没有可能做一些清算公司的事情，从而进一步降低交易成本呢？

的确如此。所以成熟的第三方支付公司内部都会有一个自己的清算中心。这个清算中心把自己当作一个外人，对资金池之间的转账交易进行清结算工作。这里要注意清算中心的结算过程涉及到资金流操作，需要通过内部支付网关来操作外部资金。

![image-20250215232110778](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502152321824.png)

**总结**

![image-20250215224942198](https://technotes.oss-cn-shenzhen.aliyuncs.com/2024/202502152249613.png)































# ==第二部分，系统的正确性保障==







# ==第三部分，分布式正确性及高可用==















