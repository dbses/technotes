> 来源：极客时间《架构实战案例解析》

# 01 | 架构的本质：如何打造一个有序的系统？

**架构的本质**

架构的本质是：通过合理的内部编排，保证复杂系统高度有序，能够不断扩展，满足业务和技术的变化。

- 保证复杂系统有序

首先，架构的出发点是业务和技术不断复杂化，引起系统混乱，从而需要通过架构来保证有序。

> 搭一个草房子很简单，可以直接上手；盖一个 2 层楼房，稍微复杂一些，但在工匠的经验 指导下，问题也不大；而盖一座高楼，复杂性就大不一样了，我们需要考虑内部结构、承重、采光、排水、防雷抗震等，这就需要专业人员事先做好整体的架构设计，并严格地按照设计来施工。

可以看到，建筑里的架构不是天然就有的，而是因为建筑越来越复杂，我们需要通过架构来管理这种复杂性，避免建造过程的失控。

软件系统也是如此，从简单的桌面应用发展到现在的大型互联网平台，这个过程中，系统规模越来越大，业务和技术也越来越复杂。我们同样需要通过架构设计，消化复杂性带来的混乱，使系统始终处于一个有序状态，能够应对现有和将来的需求变化。

- 内部编排保证有序

其次，架构实现从无序到有序，是通过合理的内部编排实现的，基本的手段，就是“分”与“合”，先把系统打散，然后将它们重新组合，形成更合理的关系。

“分”就是把系统拆分为各个子系统、模块、组件。我们比较熟悉的微服务架构，就是一种典型的拆分做法。

“合”就是基于业务流程和技术手段，把各个组件有机整合在一起。比如说在微服务架构中，拆分为具体微服务后，我们需要对这些服务进行归类和分层。

> 举个例子，在 Builder 设计模式中，它的主逻辑是将各个部件组装起来，它不关心创建某个具体部件的内部逻辑，它承担的是合的部分；工厂模式负责细粒度的构造逻辑，承担的是分的部分。大家各自管理自己的复杂性。

**架构的分类**

可以分为业务架构、应用架构和技术架构。

> 通常有很多种分法，这只是其中一种。

那么，这些架构分别为谁服务，解决什么问题？

通过一个系统的落地，首先需要人来开发，然后由机器来运行，人和机器共同参与一个系统的落地。

![image-20210720233257939](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210720233258.png)

人可能会遇到的问题：业务太复杂，系统后续维护困难；架构追求的是系统概念清晰，业务逻辑容易理解，从而使人可以直观地进行代码开发。

机器可能会遇到的问题：外部请求并发量太大，机器扛不住；架构要求的是系统能够水平扩展，支持硬件容错，保证系统的高性能和高可用。

这里，开发的痛点主要由业务架构和应用架构来解决，机器的痛点主要由技术架构来解决。

- 业务架构

业务架构就是讲清楚核心业务的处理过程，定义各个业务模块的相互关系，它从概念层面帮助我们理解系统面临哪些问题以及如何处理；

- 应用架构

应用架构就是讲清楚系统内部是怎么组织的，有哪些应用，相互间是怎么调用的，它从逻辑层面帮助我们理解系统内部是如何分工与协作的。

- 技术架构

技术架构就是讲清楚系统由哪些硬件、操作系统和中间件组成，它们是如何和我们开发的应用一起配合，应对各种异常情况，保持系统的稳定可用。它从物理层面帮助我
们理解系统是如何构造的，以及如何解决稳定性的问题。

> 举一个电商的例子。
>
> 比如一个商品业务，可能对应 3 个应用，一个前台商 品展示应用、一个后台商品管理应用，以及一个商品基础服务。
>
> 业务架构定义了一个下单的具体流程；应用架构定义了下单有哪些应用参与以及它们如何协作；技术架构要保障相关的应用能够处理高并发，从而保证大促顺利进行。

> 举一个拍电影的例子。
>
> 业务架构定义了这个电影的故事情节和场景安排；应用架构定义了有哪些角色及其职责，在每个场景中，这些角色是如何互动的；技术架构确定这些角色由谁来表演，物理场景上是怎么布置的，以此保证整个拍摄能够顺利完成。

**什么是好的架构？**

一个好的架构必须满足两方面挑战：业务复杂性和技术复杂
性。

- 业务复杂性

系统架构首先要满足当前的业务需求，还要满足将来的业务需求，系统要能不断地扩展变化，包括调整现有功能，以及增加新功能。（扩展性）

而且，系统的功能变化不能影响现有业务，不要牵一发动全身。因此，在架构设计上，要做到系统的柔性可扩展，能够根据业务变化做灵活的调整。（扩展性）

此外，上新业务功能，需要短时间就能落地。因此，架构设计上，还要做到系统功能的可重用，这样才能通过快速复用，实现业务敏捷和创新。（可重用）

- 技术复杂性

要保证一个业务能正常运行，还要保证这个系统稳定可用。

一个复杂系统是由很多部分组成的，如应用程序、服务器、数据库、网络、中间件等，都可能会出问题。那怎么在出问题时，能够快速恢复系统或者让备用系统顶上去呢?（高可用）

还有流量问题，平时流量不大，少量机器就可以处理，但在大促的时候，大量流量进来，系统是不是能够通过简单地加机器方式就能支持呢?（高并发）

此外还有低成本的问题，系统能否做到，使用廉价设备而不是高大上的 IOE 设备，使用免费的开源组件而不是昂贵的商业套件，使用虚拟化技术而不是物理机。（低成本）

**什么是好的架构师？**

一个优秀的架构师，应具备很强的综合能力。

![image-20210720225454505](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210720225454.png)

- 抽象思维

抽象思维是架构师最重要的能力，架构师要善于把实物概念化并归类。比如，面对一个大型的 B2C 网站，能够迅速抽象为采购 -> 运营 -> 前台搜索 -> 下单 -> 履单这几大模块，对系统分而治之。

- 透过问题看本质

透过问题看本质是由事物的表象到实质，往深层次挖掘。比如，看到一段 Java 代码，知道它在 JVM 中如何执行；一个跨网络调用，知道数据是如何通过各种介质（比如网卡端口）到达目标位置。

- 多领域知识和技术前瞻性

架构师要有技术的广度（多领域知识）和深度（技术前瞻）。对主流公司的系统设计非常了解，知道优劣长短，碰到实际问题，很快就能提供多种方案供评估。

- 沟通交流

能落地的架构才是好架构，架构师还需要具备良好的沟通能力，能确保各方对架构达成共识，愿意采取一致的行动。

- 平衡取舍

良好的平衡取舍能力，可以确保架构在现有资源约束下是最合理的，能让理想最终照进现实。

# 02 | 业务架构：作为开发，你真的了解业务吗？

我们知道，项目的开发都是从收集业务需求开始的，原始的需求一般来自于最终用户。但是，每个用户其实只清楚自己所负责的那部分，因此这些原始需求往往是零散的，特别是当一个业务流程跨多个部门的时候，更没有一个人能够说清楚这个业务的全貌。

所以说，仅仅基于这些原始的需求来指导开发是远远不够的，这时，就需要产品经理和架构师介入进来，填补这段空白。

**产品经理的职责**

产品经理的职责就是：告诉用户，系统长什么样子；告诉开发，他要实现什么功能。

具体需要做什么呢？

- 梳理出业务流程

首先，收集用户的原始需求，然后，将它们梳理成一个个业务流程。

> 业务流程包括输入、输出和业务功能

比如说，一个典型的购物流程，包括商品浏览、商品加入购物车、下单、支付等步骤。

![image-20210722231719861](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210722231720.png)

其中，下单步骤的输入，就是订单的各种信息，下单的功能，就是整合这些信息，创建一个具体的订单，而下单的输出结果，就是新创建的订单。

- 定义用户界面

把每个步骤具体化为页面原型。在原型中，会直观的给出各个步骤的输入或输出，以及用户的操作过程，最后再把这些页面串起来，形成一个业务流程。

总的来说，产品经理定义了系统的外表。把大量零散的原始需求经过梳理和关联，变成一系列有序的业务流程。

这些产出已经足够让用户知道，系统长什么样子了。但对于开发者来说，要实现什么功能？这些还远远不够，因为他们需要能进一步看到系统的内部结构。

而这一步，就是业务架构师要做的事情。

**业务架构师的职责**

我们设计一个购物流程模块，里面包含商品查询、添加购物车、下单和支付接口，来分别对应流程里的 4 个业务步骤。

以这样的方式构建系统，表面上看起来，业务和系统的映射好像非常简单，但在实际中，落地的难度却非常大。

- 难点一：掌握不同模块的业务和数据模型

比如说要实现一个小小的购物流程模块，就要同时涉及商品、购物车、下单和支付四个业务，模块的开发者要同时非常清楚这四部分的数据模型和业务逻辑。

- 难点二：业务改动难度大

如果一个业务领域的需求发生了变化，比如说，订单要增加一个新的状态，那么所有涉及该订单的模块都要知道这个变化，并要做出相应的调整。这就要求，每个开发者都是全知全能的，对所有业务都了如指掌。

那面对这样的业务，我们通常有哪些落地方法？

- 方法一：按业务流程来拆分业务

先把所有的业务流程拆散，这样得到了一堆业务节点；然后把业务节点进行归类，相关的业务节点放在同一个系统模块里。

![image-20210723000411735](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210723000411.png)

这种按照业务流程来拆分系统模块，对应关系比较直接，但实现起来很困难。

> 因为流程的条数是更难控制的，很容易陷入面向过程开发。

- 方法二：按业务域来拆分业务

在实际业务场景中，一个业务节点可能会涉及不同业务领域的功能。

比如说，一个下单节点，会涉及到获取商品信息、获取用户信息、扣库存、下订单等多个业务功能，那么你就可以进一步分解这个节点的功能，把不同的功能分到对应的业务域和系统模块。

基于业务域，构建了系统模块后，我们就可以按照这样的方式还原整个业务流程，比如上面的购物流程例子，我们就可以这样还原它：

```text
购物流程 = 商品模块.商品搜索 + 购物车模块.添加商品 + 订单模块.创建订单 + 支付模块.支付
```

如果你把这个定义画成序列图，就很直观和容易理解，也比较符合开发人员思维，系统实现起来非常容易。通过这种系统模块之间的不同功能组合，我们很容易给出各个业务流程的定义。

至此，我们对业务架构师应该有一个认识了。

业务架构师的工作，就是把业务流程和节点打散，按照业务域的维度来划分系统模块，并定义这些模块之间的关系，最终形成一个高度结构化的模块体系。这样，开发人员既容易理解业务，又方便落地系统。

> 产品经理和业务架构师的工作既有区别又有联系，简单地说，产品经理定义了系统的外观，满足了用户；
>
> 业务架构师在此基础上，进一步定义了系统的内部模块结构，满足了开发人员。

**架构目标之一：业务的可扩展**

业务的主题是变化和创新，系统的主题是稳定和可靠。那么，我们如何才能实现业务的快速变化和系统的相对稳定呢?

![image-20210723230556719](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210723230556.png)

我们把业务平台和业务线剥离开。业务平台封装基础通用的功能，这样，它就变得相当地稳定；各个业务线包含自己的个性化需求，业务线只依赖业务平台，业务线彼此之间互相独立，可以自由变化。这样的业务架构设计，就同时保证了系统的相对稳定和业务的快速创新。

支付宝就是采用了这样业务架构，来看一下它的演变过程。

![image-20210723231158201](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210723231158.png)

一代系统架构中，前台的业务和后台的业务直接耦合，形成了多对多的网状结构，如果修改一个后台业务线，就会影响到很多前台业务线；如果增加一条新的前台业务线，需要同时和很多后台业务线对接，这样的架构无疑是对业务的扩展非常不利的。

二代系统架构中，在前后台业务线之间，构建了独立的支付清算平台，从而实现了前台业务和后台业务的解耦。不管前台业务，还是后台业务，都只需要对接中间的支付清算平台，而业务线之间相互不影响，这样的方式，自然可以很好地支持业务扩展。

**架构目标之二：业务的可复用**

业务架构设计如何实现业务的可复用呢?

在业务架构设计中，如果基于业务流程来定义系统模块，那么，这样的系统模块很难在不同业务场景中复用。因为业务场景是经常变化的，这就导致系统模块也是经常变化。

正确的做法是按照业务域来划分业务，把业务流程中的节点拆分到各个业务域，按照业务域来构造系统模块。业务域是相对固定的，它有明确的数据模型和业务规则，这样一来，系统模块也就比较固定和通用，也就具备比较好的复用基础。

要想实现高复用，业务架构对系统模块的定义，还有更多的要求。

- 模块的职责定位要非常清晰

对于模块来说，在定位范围内的职责要全部涵盖到，而不在这个范围的职责全部不要。

- 模块的数据模型和接口设计要保证通用

架构师需要归纳业务场景，通过抽象提炼， 形成通用化的设计，以此来满足多个类似场景的需求。

- 做好业务的层次划分

越是底层的业务，它就越相对固定。所以，在做高复用设计时，我们可以尝试把一个业务域按照层次拆分得更细。

> 举个例子，同样是订单业务域，对于底层订单的增删改查功能，不同类型的订单都是一样的，但对于上层的订单生命周期管理，外卖订单和堂食订单可能就不一样。
>
> 把订单模块拆分为多个上层订单模块和一个基础订单模块，这样，基础订单模块对于所有类型的订单，都能够提供复用。

# 03 | 可扩展架构：如何打造一个柔性的系统？

什么样的系统才能具备良好的扩展能力？

**系统 = 模块 + 关系**

系统内部是有明确结构的，它可以简化表达为：系统 = 模块 + 关系。

- 模块

模块的定义。

模块是系统的基本组成部分，它泛指子系统、应用、服务或功能模块。模块内部由数据和业务逻辑组成，其中数据是核心，业务逻辑围绕着数据，对数据做进一步加工，方便外部使用。

如何划分模块？

原则一：从扩展性的角度，我们对模块的要求是---定位明确，概念完整。

每个模块要有明确的定位，它的核心职责是什么。在具体划分模块职责的时候，可以从业务、数据和功能三个角度划分。业务上，要保证模块业务概念的完整性；数据上，模块要覆盖对应业务领域的全部数据。

比如一个订单模块，它要覆盖所有渠道的订单，包括三方平台的订单、自有商城的订单、线下门店的订单等，这些不同类型订单的数据模型和实际数据，都由订单模块负责。

功能上，模块要包含业务领域的全部功能，比如订单模块包含所有订单相关的功能，包括订单数据的增删改查、订单业务规则校验、订单的状态和生命周期管理等。

原则二：模块还要---自成体系，粒度适中。

模块的业务逻辑尽量围绕自身内部数据进行处理，对外部依赖越小，模块的封装性越好，稳定性也越强。

模块的粒度要保持适中，不能为了追求定位清晰，把粒度划分得很小，导致系统的碎片化。

> 比如系统早期的时候，一般我们把积分功能放到用户模块里面，不单独构建积分模块，如果后续积分的概念越来越突出，承载的业务越来越复杂，到时候可以把积分功能分离出来，单独成模块。

- 依赖关系

依赖关系的定义。

关系指模块之间的依赖关系，简单地讲，就是模块之间的调用关系，我们知道，调用区分发起方和服务方，因此，依赖关系是有方向性的。

如何定义依赖关系？

原则一：简化依赖方向。

首先，我们希望模块之间的依赖是单向的，尽量避免相互调用。

为什么单向更好呢？模块依赖关系越直观体现业务流程，越能帮助人理解，否则，我们会被双向的依赖箭头绕的晕头转向，很难通过模块之间的依赖关系还原实际业务的处理过程。

原则二：和减少依赖的数量。

其次，我们要尽量把网状结构转化为层次结构，模块结构层次化是简化模块依赖关系的有力手段。

具体做法就是，我们按照模块定位的不同，把模块划分为不同层次。这样，一个层通过把多个模块组织在一起，就形成了概念上更大粒度的模块，我们理解业务时，关注这个更大粒度的层就可以。依赖关系也只要指向这个层，这样，从理解业务的角度，依赖的数量大幅度地减少了。

MVC 定义的依赖关系就遵循了上述原则。

系统模块按照定位，分为表示层（View层）、 应用层（Control层）、聚合服务层（Model加强层）、基础服务层（Model层）。

> 聚合服务层，如果系统业务比较复杂，经常需要单独的聚合服务层负责业务流程的编排 组合，这个属于 Model 层的加强。

![image-20210725231045992](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210725231046.png)

**打造可扩展的模块体系：模块拆分**

如何打造一个合理的模块体系?

具体的架构手段就是按照业务对系统进行拆分和整合：通过拆分，实现模块划分；通过整合，优化模块依赖关系。

接下来，我们以一个在线出行公司为例，它有出租车、快车和顺风车 3 条业务线，来具体看下如何为它打造合理的模块体系。

我们先对系统进行模块化拆分，拆分有两种方式：水平拆分和垂直拆分。

![image-20210726232226977](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210726232227.png)

- 水平拆分

如何进行水平拆分？

水平拆分是指从上到下把系统分为多层。比如，整个叫车过程，我们可以分为 UI 展现、地图搜索、运力调度和订单支付等几个环节，这是根据系统的处理过程进行划分的。

水平拆分的优点：

1. 功能内聚。通过水平拆分，可以使每一块职责都比较明确，每个模块管理自己内部的复杂性；
2. 模块之间相互松耦合。一个模块的修改不影响另一个模块，比如地图搜索模块中改变了优先路径的推荐，不会影响运力调度模块中的人车匹配算法。
3. 现有业务可做深度扩展。当业务有变化时，系统在特定层做调整，对其他层影响有限，这样把变化局限在一个小范围。

- 垂直拆分

如何进行垂直拆分？

垂直拆分指的是按照不同的业务线拆分，比如，将整个出行业务分为出租车业务、快车业务和顺风车业务，让每个业务都自成体系，形成自己的业务闭环。

垂直拆分的优点：

1. 降低了整个系统的复杂性。通过垂直拆分，一个复杂的出行场景拆分为了几个具体的场景，我们可以根据各个业务线的特点去设计系统。
2. 现有业务可做广度扩展。比如说增加一条新的业务线，可以按照这个思路落地系统。

一般做业务架构时，我们先考虑垂直拆分，从大方向上，把不同业务给区分清楚，然后再针对具体业务，按照业务处理流程进行水平拆分。

**打造可扩展的模块体系：模块整合**

系统拆完后，接下来就是模块整合的工作，整合也有两种好的手段：通用化和平台化。

- 通用化整合

通用化指的是通过抽象设计，让一个模块具备通用的能力，能够替代多个类似功能的模块。

如何进行通用化整合？

回到刚才的出行平台，我们发现 3 条业务线都有地图搜索、运力调度、订单支付这些模块，不同的业务线之间，这些同名的模块逻辑高度类似，只是细节方面有差别。那么我们可以对这些类似的模块进行抽象化处理，整合成一个通用的模块。

我们可以在模块接口中，通过输入参数标识调用来自哪个业务，是出租车、快车还是顺风车，然后在模块内部，针对不同业务线的差异化部分做针对性处理。

通用化整合的优点：

1. 为多个业务线提供了复用。可能这个通用模块增加 5% 的逻辑，但避免了 95% 的重复逻辑。当新的业务线进来，很可能这个通用化的模块，就已经提供了现成的支持。
2. 模块的数量减少了，模块的定位更清晰，概念更完整，职责更聚焦。

在实践中，当不同业务线对某个功能需求比较类似时，我们经常会使用这个手段。

- 平台化整合

平台化是把定位相同的模块组织在一起，以组团的方式对外提供服务。对于外部系统来说，我们可以把这些模块看成是一个整体，一起对业务场景提供全面的支撑。

如何进行平台化整合？

如下图所示，我们可以看到，地图搜索、运力调度、订单支付，都是各个业务线都需要的基础和通用的业务能力，当我们增加新的业务线时，还是离不开这些基础能力。

![image-20210725232113498](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/images/20210725232113.png)

所以，我们可以把这些基础模块放在同一层，构成一个基础业务平台。之前，它们是一个个离散的服务，独立地输出能力，现在变成一个大的业务平台，可以提供整体的能力输出。

平台化整合的优点：

1. 我们对多个业务模块进行包装，形成更大粒度的抽象，相当于减少了模块的数量；
2. 作为平台，它的定位更明确，系统依赖关系也更清晰；
3. 新的业务线进来，它可以基于业务平台快速落地；

业务平台化是模块依赖关系层次化的一个特例，只是它偏向于基础能力，在实践中，当业务线很多，业务规则很复杂时，我们经常把底层业务能力抽取出来，进行平台化处理。

