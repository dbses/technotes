> 来源极客时间《DDD实战课》--欧创新

# 11 | DDD实践：如何用DDD重构中台业务模型？

**互联网电商平台和传统应用分析**

![image-20230228231838497](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202302282318580.png)

这两者在业务功能上会有很多相似和差异，这种相似和差异主要体现在四个方面。

1. 核心能力的重复建设。传统保险核心应用有报价、投保、核保和出单功能，同样在互联网电商平台也有。这就是核心能力的重复建设。
2. 通用能力的重复建设。比如用户、客户等。
3. 业务职能的分离建设。
4. 互联网电商平台和传统核心功能前后完全独立建设。

如何避免重复造轮子？

要避免重复建设，就要理解中台的理念和思想。前面说了“中台是企业级能力复用平台”，“复用”用白话说就是重复使用，就是要避免重复造轮子的事情。

中台的设计思想与“高内聚、低耦合”的设计原则是高度一致的。高内聚是把相关的业务行为聚集在一起，把不相关的行为放在其它地方，如果你要修改某个业务行为，只需要修改一处。

**如何构建中台业务模型？**

1、自顶向下的策略

领域建模过程主要基于业务现状，暂时不考虑系统现状。自顶向下的策略适用于全新的应用系统建设，或旧系统推倒重建的情况。

第一步是将领域分解为子域，子域可以分为核心域、通用域和支撑域；

第二步是对子域建模，划分领域边界，建立领域模型和限界上下文；

第三步则是根据限界上下文进行微服务设计。

![image-20230308224749733](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303082247809.png)

2、自底向上的策略

这种策略是基于业务和系统现状完成领域建模。

这个过程会沉淀公共和复用的业务能力，会将分散的业务模型整合。自底向上策略适用于遗留系统业务模型的演进式重构。

第一步：锁定系统所在业务域，构建领域模型。采用事件风暴，找出领域对象，构建聚合，划分限界上下文，建立领域模型。

![image-20230308225032881](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303082250922.png)

第二步：对齐业务域，构建中台业务模型。中台业务建模时，既要关注领域模型的完备性，也要关注不同渠道敏捷响应市场的要求。

![image-20230308225235084](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303082252118.png)

有了上述这样一个思路，我们就可以开始构建中台业务模型了。下面我以客户为例，来给你讲一下客户中台业务模型的构建过程。

互联网电商客户主要面向个人客户，除了有个人客户信息管理功能外，基于营销目的它还有客户积分功能，因此它的领域模型有个人和积分两个聚合。

最终个人客户的领域模型重构为：个人、归并和视图三个聚合重构为个人领域模型（客户信息管理），评级和积分两个聚合重构为评级积分领域模型（面向个人客户）。到这里我们就完成了个人客户领域模型的构建了。

至此我们就完成了客户中台业务模型的构建了，客户中台构建了个人、团体和评级积分三个领域模型。总结成一句话就是：“分域建模型，找准基准域，划定上下文，聚合重归类。”

第三步：中台归类，根据领域模型设计微服务。

完成中台业务建模后，我们就有了下面这张图。从这张图中我们可以看到总共构建了多少个中台，中台下面有哪些领域模型，哪些中台是通用中台，哪些中台是核心中台，中台的基本信息等等，都一目了然。你根据中台下的领域模型就可以设计微服务了。

![image-20230308225719605](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303082257639.png)

**重构过程中的领域对象**

传统核心客户领域模型重构之前，包含个人、团体和评级三个聚合，每个聚合内部都有自己的聚合根、实体、方法和领域服务等。

![image-20230315214137670](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152141741.png)

互联网电商客户领域模型重构前包含个人和积分两个聚合，每个聚合包含了自己的领域对象、方法和领域服务等。

![image-20230315214212497](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152142529.png)

# 12 | 领域建模：如何用事件风暴构建领域模型？

那么我们该采用什么样的方法，才能从错综复杂的业务领域中分析并构建领域模型呢？

**事件风暴需要准备些什么？**

1. 事件风暴的参与者
2. 事件风暴要准备的材料
3. 事件风暴的场地
4. 事件风暴分析的关注点

**如何用事件风暴构建领域模型？**

领域建模的过程主要包括产品愿景、业务场景分析、领域建模和微服务拆分与设计这几个重要阶段。

**总结**

很多开发人员在初次学习 DDD 时，似乎并不太关心领域建模，而只是想学学 DDD 的战术设计思想，快速上手，开发微服务。我想这是对 DDD 的一个误解，这已经偏离了 DDD 的核心设计思想，即先有边界清晰的领域模型，才能设计出清晰的微服务边界，这两个阶段一前一后是刚需，我们不能忽略。

# 13 | 代码模型（上）：如何使用DDD设计微服务代码模型？

上一讲我们完成了领域模型的设计，接下来我们就要开始微服务的设计和落地了。那微服务落地时首先要确定的就是微服务的代码结构，也就是我今天要讲的微服务代码模型。

**DDD 分层架构与微服务代码模型**

![image-20230315220608802](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152206847.png)

微服务代码模型

微服务一级目录结构

微服务一级目录是按照 DDD 分层架构的分层职责来定义的。

![image-20230315220731541](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152207578.png)

各层目录结构 -- Interfaces

![image-20230315220823600](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152208634.png)

- Assembler：实现 DTO 与领域对象之间的相互转换和数据交换。一般来说 Assembler 与 DTO 总是一同出现。
- Dto：它是数据传输的载体，内部不存在任何业务逻辑，我们可以通过 DTO 把内部的领域对象与外界隔离。
- Facade：提供较粗粒度的调用接口，将用户请求委派给一个或多个应用服务进行处理。

应用层 -- application

![image-20230315220956372](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152209416.png)

领域层 -- domain

![image-20230315221118042](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152211081.png)

基础层 -- infrastructure

![image-20230315221452634](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152214671.png)

代码模型总目录结构

![image-20230315221539452](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303152215486.png)

# 14 | 代码模型（下）：如何保证领域模型与代码模型的一致性？

要想完成微服务的设计和落地，除了提取出领域对象（聚合、实体、命令和领域事件等）、建立微服务代码模型外，其实还有一步，也就是我们今天的重点——将领域对象映射到微服务代码模型中。那为什么这一步如此重要呢？

我们需要将领域模型作为微服务设计的输入，对领域对象进行设计和转换，让领域对象与代码对象建立映射关系。

**领域对象的整理**

一个领域模型会包含多个聚合，一个聚合包含多个领域对象。

![image-20230316225911391](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303162259466.png)

**从领域模型到微服务的设计**

这个过程会比事件风暴来的更深入和细致。主要关注内容如下：

- 分析微服务内有哪些服务？
- 服务所在的分层？
- 应用服务由哪些服务组合和编排完成？
- 领域服务包括哪些实体的业务逻辑？
- 采用充血模型的实体有哪些属性和方法？
- 有哪些值对象？
- 哪个实体是聚合根等？

**领域层的领域对象**

> ```
> -- 接口层
> -- 应用层
> -- 领域层
>     |--聚合
>         |--实体：个人客户、地址、电话、银行账号
>         |--事件：客户已创建
>         |--领域服务
>         |--仓储
> -- 基础层
> ```

事件风暴结束时，领域模型聚合内一般会有：聚合、实体、命令和领域事件等领域对象。

在完成故事分析和微服务设计后，微服务的聚合内一般会有：聚合、聚合根、实体、值对象、领域事件、领域服务和仓储等领域对象。

1、设计实体：实体类放在领域层的 Entity 目录结构下。

大多数情况下，领域模型的业务实体与微服务的数据库实体是一一对应的。我们分析个人客户时，还需要有地址、电话和银行账号等实体，它们被聚合根引用。

在分层架构里，实体采用充血模型，在实体类内实现实体的全部业务逻辑。这些不同的实体都有自己的方法和业务行为，比如地址实体有新增和修改地址的方法，银行账号实体有新增和修改银行账号的方法。

2、找出聚合根：聚合根类放在代码模型的 Entity 目录结构下。

聚合根来源于领域模型，在个人客户聚合里，个人客户这个实体是聚合根，它负责管理地址、电话以及银行账号的生命周期。

聚合根是一种特殊的实体，它有自己的属性和方法。聚合根可以实现聚合之间的对象引用，还可以引用聚合内的所有实体。聚合根有自己的实现方法，比如生成客户编码，新增和修改客户信息等方法。

3、设计值对象：值对象类放在代码模型的 Entity 目录结构下。

根据需要将某些实体的某些属性或属性集设计为值对象。在个人客户聚合中，客户拥有客户证件类型，它是以枚举值的形式存在，所以将它设计为值对象。

4、设计领域事件：领域事件的发布和订阅类我建议放在应用层的 Event 目录结构下。

如果领域模型中领域事件会触发下一步的业务操作，我们就需要设计领域事件。首先确定领域事件发生在微服务内还是微服务之间。然后设计事件实体对象，事件的发布和订阅机制，以及事件的处理机制。判断是否需要引入事件总线或消息中间件。

5、设计领域服务：领域服务类放在领域层的 Service 目录结构下。

如果一个业务动作或行为跨多个实体，我们就需要设计领域服务。

6、设计仓储：仓储代码放在领域层的 Repository 目录结构下。

每一个聚合都有一个仓储，仓储主要用来完成数据查询和持久化操作。

> 在 Github 找找 DDD 的落地项目。

**应用层的领域对象**

> ```
> -- 接口层
> -- 应用层
>     |--事件订阅
>     |--应用服务
> -- 领域层
>     |--聚合
>         |--实体：个人客户、地址、电话、银行账号
>         |--事件：客户已创建
>         |--领域服务
>         |--仓储
> -- 基础层
> ```

应用层的主要领域对象是应用服务和事件的发布以及订阅。

在严格分层架构模式下，不允许服务的跨层调用，每个服务只能调用它的下一层服务。服务从下到上依次为：实体方法、领域服务和应用服务。

如果需要实现服务的跨层调用，可以采用服务逐层封装的方式。

![image-20230316230732921](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303162307964.png)

**领域对象与微服务代码对象的映射**

1、典型的领域模型

个人客户领域模型中的个人客户聚合，就是典型的领域模型，从聚合内可以提取出多个实体和值对象以及它的聚合根。

![image-20230316231020742](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303162310795.png)

- 层：定义领域对象位于分层架构中的哪一层，比如：接口层、应用层、领域层以及基础层等。
- 领域对象：领域模型中领域对象的具体名称。
- 领域类型：根据 DDD 知识体系定义的领域对象的类型，包括：限界上下文、聚合、聚合根、实体、值对象、领域事件、应用服务、领域服务和仓储服务等领域类型。
- 依赖的领域对象：根据业务对象依赖或分层调用的依赖关系，建立的领域对象的依赖关系，比如：服务调用依赖、关联对象聚合等。
- 包名：代码模型中的包名，对应领域对象所在的软件包。
- 类名：代码模型中的类名，对应领域对象的类名。
- 方法名：代码模型中的方法名，对应领域对象实现或操作的方法名。

在建立这种映射关系后，我们就可以得到如下图的微服务代码结构了。

![image-20230316231244005](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303162312044.png)

2、非典型领域模型

比如，在个人客户领域模型内有客户归并的聚合，它扫描所有客户，按照身份证号码、电话号码等是否重复的业务规则，判断是否是重复的客户，然后对重复的客户进行归并。这种业务场景你就找不到聚合根。

那对于这类非典型模型，我们怎么办？





















