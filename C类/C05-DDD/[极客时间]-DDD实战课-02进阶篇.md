> 来源极客时间《DDD实战课》--欧创新

# 06 | 领域事件：解耦微服务的关键

**领域事件及实现**

领域事件是用来表示领域中发生的事件。一个领域事件将导致进一步的业务操作，在实现业务解耦的同时，还有助于形成完整的业务闭环。

领域事件的执行需要一系列的组件和技术来支撑。我们来看一下这个领域事件总体技术架构图（技术架构只作参考）。

![image-20220126223620367](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220126223620.png)

主要技术包括：

1. 事件构建和发布：事件基本属性（包括事件唯一标识、发生时间、事件类型和事件源等）和业务属性一起构成事件实体，发布到消息中间件。
2. 事件数据持久化：事件数据持久化可用于系统之间的数据对账，当遇到系统宕机或者网络中断，在问题解决后仍可继续后续业务流转，保证数据的一致性。
3. 事件总线 (EventBus)：事件总线是进程内模型，如果同时存在微服务内和外订阅者，则先分发到内部订阅者并持久化，再异步发送到消息中间件。
4. 消息中间件。
5. 事件接收和处理。

**领域事件相关案例**

以保险承保业务过程为例，当前发生的领域事件是：缴费通知单已生成。下一步的业务操作是：缴费。

![image-20220126221726276](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220126221726.png)

1. 投保微服务生成缴费通知单，发布第一个事件：缴费通知单已生成。
2. 收款微服务缴费完成后，发布第二个领域事件：缴费已完成。
3. 投保微服务在投保单转保单完成后，发布第三个领域事件：保单已生成。
4. 保单微服务完成保单数据保存后，后面还会发生一系列的领域事件，这里就不详细说了。

总之，通过领域事件驱动的异步化机制，可以推动业务流程和数据在各个不同微服务之间的流转。

# 07 | DDD分层架构：有效降低层与层之间的依赖

**什么是 DDD 分层架构？**

DDD 的分层架构在不断发展。最早是传统的四层架构；后来四层架构有了进一步的优化，实现了各层对基础层的解耦；

![image-20220127215044480](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220127215044.png)

在最早的传统四层架构中，基础层是被其它层依赖的，它位于最核心的位置。但实际上领域层才是软件的核心，后来采用依赖倒置的设计原则，优化了传统的四层架构。

优化后的四层架构从上到下依次是：用户接口层、应用层、领域层和基础层。

![image-20220127211912926](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220127211913.png)

1. 用户接口层。
2. 应用层：应用层是很薄的一层，完成微服务之间的服务组合和编排。
3. 领域层：领域层的作用是实现企业核心业务逻辑，通过各种校验手段保证业务的正确性。
4. 基础层：基础层是贯穿所有层的，它的作用就是为其它各层提供通用的技术和基础服务。

**三层架构如何演进到 DDD 分层架构？**

DDD 分层架构中的要素其实和三层架构类似，只是在 DDD 分层架构中，这些要素被重新归类，重新划分了层，确定了层与层之间的交互规则和职责边界。

![image-20220127221640974](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220127221641.png)

三层架构向 DDD 分层架构演进，主要发生在业务逻辑层和数据访问层。

第一，DDD 分层架构在用户接口层引入了 DTO，给前端提供了更多的可使用数据和更高的展示灵活性。

第二，DDD 分层架构将业务逻辑层的服务拆分到了应用层和领域层。应用层快速响应前端的变化，领域层实现领域模型的能力。

第三，DDD 分层架构的数据库等基础资源访问，采用了仓储（Repository）设计模式，通过依赖倒置实现各层对基础资源的解耦。

传统三层架构向 DDD 分层架构的演进，体现的正是领域驱动设计思想的演进。希望你也感受到了，并尝试将其应用在自己的架构设计中。



