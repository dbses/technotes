> 来源极客时间《DDD实战课》--欧创新

# 06 | 领域事件：解耦微服务的关键

**领域事件及实现**

领域事件是用来表示领域中发生的事件。一个领域事件将导致进一步的业务操作，在实现业务解耦的同时，还有助于形成完整的业务闭环。

领域事件的执行需要一系列的组件和技术来支撑。我们来看一下这个领域事件总体技术架构图（技术架构只作参考）。

![image-20220126223620367](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220126223620.png)

主要技术包括：

1. 事件构建和发布：事件基本属性（包括事件唯一标识、发生时间、事件类型和事件源等）和业务属性一起构成事件实体，发布到消息中间件。
2. 事件数据持久化：事件数据持久化可用于系统之间的数据对账，当遇到系统宕机或者网络中断，在问题解决后仍可继续后续业务流转，保证数据的一致性。
3. 事件总线 (EventBus)：事件总线是进程内模型，如果同时存在微服务内和外订阅者，则先分发到内部订阅者并持久化，再异步发送到消息中间件。
4. 消息中间件。
5. 事件接收和处理。

**领域事件相关案例**

以保险承保业务过程为例，当前发生的领域事件是：缴费通知单已生成。下一步的业务操作是：缴费。

![image-20220126221726276](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220126221726.png)

1. 投保微服务生成缴费通知单，发布第一个事件：缴费通知单已生成。
2. 收款微服务缴费完成后，发布第二个领域事件：缴费已完成。
3. 投保微服务在投保单转保单完成后，发布第三个领域事件：保单已生成。
4. 保单微服务完成保单数据保存后，后面还会发生一系列的领域事件，这里就不详细说了。

总之，通过领域事件驱动的异步化机制，可以推动业务流程和数据在各个不同微服务之间的流转。

# 07 | DDD分层架构：有效降低层与层之间的依赖

**什么是 DDD 分层架构？**

DDD 的分层架构在不断发展。最早是传统的四层架构；后来四层架构有了进一步的优化，实现了各层对基础层的解耦；

![image-20220127215044480](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220127215044.png)

在最早的传统四层架构中，基础层是被其它层依赖的，它位于最核心的位置。但实际上领域层才是软件的核心，后来采用依赖倒置的设计原则，优化了传统的四层架构。

优化后的四层架构从上到下依次是：用户接口层、应用层、领域层和基础层。

![image-20220127211912926](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220127211913.png)

1. 用户接口层。
2. 应用层：应用层是很薄的一层，完成微服务之间的服务组合和编排。
3. 领域层：领域层的作用是实现企业核心业务逻辑，通过各种校验手段保证业务的正确性。
4. 基础层：基础层是贯穿所有层的，它的作用就是为其它各层提供通用的技术和基础服务。

**三层架构如何演进到 DDD 分层架构？**

DDD 分层架构中的要素其实和三层架构类似，只是在 DDD 分层架构中，这些要素被重新归类，重新划分了层，确定了层与层之间的交互规则和职责边界。

![image-20220127221640974](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220127221641.png)

三层架构向 DDD 分层架构演进，主要发生在业务逻辑层和数据访问层。

第一，DDD 分层架构在用户接口层引入了 DTO，给前端提供了更多的可使用数据和更高的展示灵活性。

第二，DDD 分层架构将业务逻辑层的服务拆分到了应用层和领域层。应用层快速响应前端的变化，领域层实现领域模型的能力。

第三，DDD 分层架构的数据库等基础资源访问，采用了仓储（Repository）设计模式，通过依赖倒置实现各层对基础资源的解耦。

传统三层架构向 DDD 分层架构的演进，体现的正是领域驱动设计思想的演进。希望你也感受到了，并尝试将其应用在自己的架构设计中。

# 08 | 微服务架构模型：几种常见模型的对比和分析

**整洁架构**

整洁架构又名“洋葱架构”。整洁架构最主要的原则是依赖原则，它定义了各层的依赖关系，越往里依赖越低，代码级别越高，越是核心能力。外圆代码依赖只能指向内圆，内圆不需要知道外圆的任何情况。

![image-20220128225631920](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220128225632.png)

1. 领域模型实现领域内核心业务逻辑，它封装了企业级的业务规则；
2. 领域服务实现涉及多个实体的复杂业务逻辑；
3. 应用服务实现与用户操作相关的服务组合与编排；
4. 最外层主要提供适配的能力。

**六边形架构**

六边形架构又名“端口适配器架构”。六边形架构的核心理念是：应用是通过端口与外部进行交互的。

![image-20220128225754377](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220128225754.png)

在六边形架构中，红圈内的核心业务逻辑与外部资源完全隔离，仅通过适配器进行交互。它解决了业务逻辑与用户界面的代码交错问题，很好地实现了前后端分离。

红圈内的六边形实现应用的核心业务逻辑；外六边形完成外部应用、驱动和基础资源等的交互和访问，对前端应用以 API 主动适配的方式提供服务，对基础资源以依赖倒置被动适配的方式实现资源访问。

# 09 | 中台：数字转型后到底应该共享什么？

**平台到底是不是中台？**

阿里业务中台的前身是共享平台，而原来的共享平台更多的被当作资源团队，他们承接各业务方的需求，并为业务方在基础服务上做定制开发。

平台只是将部分通用的公共能力独立为共享平台，解决系统重复建设的问题，但这类平台并没有将核心业务服务链路作为一个整体方案考虑，各平台仍然是分离且独立的。

阿里业务中台的目标是把核心服务链路（会员、商品、交易、营销、店铺、资金结算等）整体当作一个平台产品来做，为前端业务提供的是业务解决方案，而不是彼此独立的系统。

平台解决了公共能力复用的问题，但离中台的目标显然还有一段差距！

**中台到底是什么？**

思特沃克对中台的定义：“中台是企业级能力复用平台。”

中台提供的是一套企业级的整体解决方案，它主要体现在这三个关键能力上：对前台业务的快速响应能力；企业级复用能力；从前台、中台到后台的设计、研发、页面操作、流程服务和数据的无缝联通、融合能力。

**数字化转型中台应该共享什么？**

![image-20220208222904148](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220208222904.png)

传统企业不仅要将通用能力中台化，还需要将核心能力中台化。这里的通用能力对应 DDD 的通用域或支撑域；核心能力对应 DDD 的核心域。

业务中台需要解决核心业务链路的联通和不同渠道服务共享的问题。数据中台需要解决系统微服务拆分后的数据孤岛、数据融合和业务创新等问题。

# 10 | DDD、中台和微服务：它们是如何协作的？

中台是抽象出来的业务模型，微服务是业务模型的系统实现，DDD 作为方法论可以同时指导中台业务建模和微服务建设，三者相辅相成，完美结合。

**中台的本质**

中台的本质其实就是提炼各个业务板块的共同需求，进行业务和系统抽象，形成通用的可复用的业务模型，打造成组件化产品，供前台部门使用。前台要做什么业务，需要什么资源，可以直接找中台，不需要每次都去改动自己的底层。

**DDD、中台和微服务的协作模式**

![image-20220209215032513](https://gitee.com/yanglu_u/img2022/raw/master/learn/20220209215032.png)

如果将企业内整个业务域作为一个问题域的话，企业内的所有业务就是一个领域。

在进行领域细分时，从 DDD 视角来看，子域可分为核心域、通用域和支撑域。从中台建设的视角来看，业务域细分后的业务中台，可分为核心中台和通用中台。

