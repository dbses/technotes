一、

在我们的项目中使用了 Log4j2 日志框架，日志配置`log4j.yml`是这样的：

```yaml
Configuration:
  status: warn
  
  Appenders:
    Console:
      name: Console
      target: SYSTEM_OUT
      # 不重要
    RollingFile:
      - name: ROLLING_FILE
        # 不重要
  Loggers:
    Root:
      level: info
      AppenderRef:
        - ref: Console
        - ref: ROLLING_FILE
    Logger:
      - name: com.myproject
        level: info
```

现在莫名来了这么一个需求：要把项目的接口访问日志单独打印到一个日志文件`logs/access.log`中，访问日志功能由配置开关决定是否开启。

`log4j_with_accesslog.yml`

```yaml
Configuration:
  status: warn
  
  Appenders:
    Console:
      name: Console
      target: SYSTEM_OUT
      # 不重要
    RollingFile:
      - name: ROLLING_FILE
        # 不重要
        ### 新增的配置开始 ###（1）
      - name: ACCESS_LOG
        fileName: logs/access.log
        ### 新增的配置结束 ###
  Loggers:
    Root:
      level: info
      AppenderRef:
        - ref: Console
        - ref: ROLLING_FILE
    Logger:
      - name: com.myproject
        level: info
      ### 新增的配置开始 ###（2）
      - name: com.myproject.commons.AccessLog
        level: trace
        additivity: false
        AppenderRef:
          - ref: Console
          - ref: ACCESS_LOG
      ### 新增的配置结束 ###
```

并且在项目启动时做了判断。

```java
import org.springframework.boot.logging.log4j2.Log4J2LoggingSystem;

/**
 * @author <a href="mailto:yanglu_u@126.com">杨同学</a>
 */
public class MyProjectLoggingSystem extends Log4J2LoggingSystem {

    static final boolean accessLogEnabled =
            Boolean.parseBoolean(System.getProperty("casslog.accessLogEnabled", "true"));

    @Override
    protected String[] getStandardConfigLocations() {
        if (accessLogEnabled) {
            return new String[]{"casslog_with_accesslog.yml"};
        }
        return new String[]{"casslog.yml"};
    }
}
```

二、

> Nacos 源码版本：`nacos-client 1.4.1`



```java
import static org.slf4j.LoggerFactory.getLogger;

public class LogUtils {
    public static final Logger NAMING_LOGGER;
    static {
        NacosLogging.getInstance().loadConfiguration();
        NAMING_LOGGER = getLogger("com.alibaba.nacos.client.naming");
    }
}
```

```java
public class NacosLogging {
    private AbstractNacosLogging nacosLogging;
    public void loadConfiguration() {
        try {
            nacosLogging.loadConfiguration();
        }
        // 省略...
    }
}
```

```java
public abstract class AbstractNacosLogging {
    public abstract void loadConfiguration();
}
```

```java
public class Log4J2NacosLogging extends AbstractNacosLogging {
    private final String location = getLocation("classpath:nacos-log4j2.xml");
    @Override
    public void loadConfiguration() {
        final LoggerContext loggerContext = (LoggerContext) LogManager.getContext(false);
        final Configuration contextConfiguration = loggerContext.getConfiguration();
        
        // load and start nacos configuration
        Configuration configuration = loadConfiguration(loggerContext, location);
        configuration.start();
        
        // append loggers and appenders to contextConfiguration
        Map<String, Appender> appenders = configuration.getAppenders();
        for (Appender appender : appenders.values()) {
            contextConfiguration.addAppender(appender);
        }
        Map<String, LoggerConfig> loggers = configuration.getLoggers();
        for (String name : loggers.keySet()) {
            if (name.startsWith(NACOS_LOGGER_PREFIX)) {
                contextConfiguration.addLogger(name, loggers.get(name));
            }
        }
        
        loggerContext.updateLoggers();
    }
}
```

```xml
<Configuration status="WARN">
    <Appenders>
        <RollingFile name="CONFIG_LOG_FILE" fileName="${sys:JM.LOG.PATH}/nacos/config.log"
            filePattern="${sys:JM.LOG.PATH}/nacos/config.log.%d{yyyy-MM-dd}.%i">
            <!-- 不重要 -->
        </RollingFile>
        <RollingFile name="NAMING_LOG_FILE" fileName="${sys:JM.LOG.PATH}/nacos/naming.log"
            filePattern="${sys:JM.LOG.PATH}/nacos/naming.log.%d{yyyy-MM-dd}.%i">
            <!-- 不重要 -->
        </RollingFile>
    </Appenders>
    
    <Loggers>
        <!-- 不重要 -->
        <Logger name="com.alibaba.nacos.client.config" level="${sys:com.alibaba.nacos.config.log.level:-info}"
            additivity="false">
            <AppenderRef ref="CONFIG_LOG_FILE"/>
        </Logger>
        <Logger name="com.alibaba.nacos.client.naming" level="${sys:com.alibaba.nacos.naming.log.level:-info}"
            additivity="false">
            <AppenderRef ref="NAMING_LOG_FILE"/>
        </Logger>
        <!-- 不重要 -->
    </Loggers>
</Configuration>
```

三、

```java
/**
 * @author <a href="mailto:yanglu_u@126.com">杨同学</a>
 */
@Slf4j
public abstract class AbstractLogExtend {
    public void loadConfiguration() {
        final LoggerContext loggerContext = (LoggerContext) LogManager.getContext(false);
        final Configuration contextConfiguration = loggerContext.getConfiguration();

        // load and start casslog extend configuration
        Configuration configurationExtend = loadConfiguration(loggerContext);
        configurationExtend.start();

        // append loggers and appenders to contextConfiguration
        Map<String, Appender> appenders = configurationExtend.getAppenders();
        for (Appender appender : appenders.values()) {
            addAppender(contextConfiguration, appender);
        }
        Map<String, LoggerConfig> loggersExtend = configurationExtend.getLoggers();
        loggersExtend.forEach((loggerName, loggerConfig) ->
                addLogger(contextConfiguration, loggerName, loggerConfig)
        );

        loggerContext.updateLoggers();
    }
    private Configuration loadConfiguration(LoggerContext loggerContext) {
        try {
            URL url = ResourceUtils.getResourceUrl(logConfig());
            ConfigurationSource source = getConfigurationSource(url);
            // since log4j 2.7 getConfiguration(LoggerContext loggerContext, ConfigurationSource source)
            return ConfigurationFactory.getInstance().getConfiguration(loggerContext, source);
        } catch (Exception e) {
            throw new IllegalStateException("Could not initialize Log4J2 logging from " + logConfig(), e);
        }
    }
    /**
     * 要扩展配置的文件名
     */
    public abstract String logConfig();
}
```

```java
/**
 * @author <a href="mailto:yanglu_u@126.com">杨同学</a>
 */
public class LogExtendInitializer {
    
    private final List<AbstractLogExtend> cassLogExtends;
    
    @PostConstruct
    public void init() {
        cassLogExtends.forEach(cassLogExtend -> {
            try {
                cassLogExtend.loadConfiguration();
            }
            // 省略...
        });
    }
}
```

基础类代码写好了。

```java
/**
 * @author <a href="mailto:yanglu_u@126.com">杨同学</a>
 */
public class AccessLogConfigExtend extends AbstractLogExtend {

    @Override
    public String logConfig() {
        return "classpath:com/myproject/accesslog/accesslog-log4j.xml";
    }

}
```

```xml
<Configuration status="WARN">
    <Appenders>
        <!-- 不重要 -->
        <RollingFile name="ACCESS_LOG" fileName="logs/access.log"
                     filePattern="logs/$${date:yyyy-MM}/access-%d{yyyy-MM-dd}-%i.log.gz">
            <!-- 不重要 -->
        </RollingFile>
    </Appenders>

    <Loggers>
        <Root level="INFO"/>
        <Logger name="com.myproject.commons.AccessLog" level="trace" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="ACCESS_LOG"/>
        </Logger>
    </Loggers>
</Configuration>
```

