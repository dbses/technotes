# 一、领域驱动设计与微服务

## 如何理解领域驱动设计？

拆开理解：首先是领域，再是设计。想要设计一个软件，但是由于业务太过复杂，设计过程难以进行。这时，使用领域的思想来辅助设计。

## 如果你是业务架构师，你在设计过程中会遇到哪些难题呢？

我想你面临的第一个问题就是，软件架构的选型，是使用单体架构，还是使用微服务架构？

如果你的业务不复杂，使用单体架构就可以满足了。既然业务不复杂，那也不需要用领域来驱动设计了。

所以我们谈领域驱动设计，一定是在业务复杂的前提下。既然业务复杂，所以你会选择微服务架构，为什么？因为微服务架构可以快速响应需求和业务的变化。

## 好！既然选择了微服务，那服务的粒度怎么确定呢？

有人说，微服务嘛，就是要微要小，拆得越小越好。（举反例）

xxx

## 到底应该怎么拆？

DDD 是一种处理高度复杂领域的设计思想，它通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易地实现架构演进。

第一步，事件风暴，找出领域实体对象。

第二步，根据领域实体间的业务关联，将相关的实体组合形成聚合。它们属于同一个微服务。

第三步，根据语义边界，将多个聚合划定在一个限界上下文内，形成领域模型。这一层边界就是微服务的边界。

# 二、DDD 领域的思想

在研究和解决业务问题时，DDD 会按一定的规则将业务领域进行细分。举个例子：我们要研究桃树。

首先我们可以将桃树拆分为根、茎、叶，花、果、种子。

拆分后就是领域中的子领域，即子域。

## 子域

根、茎、叶，花、果、种子。再按照重要程度进行划分，分为核心域、通用域、支撑域。

这六个子域，哪个才是核心域呢？

园丁（花）、果农（果）。

对他们来说，茎、叶都是支撑域。

通用域是你需要用到的通用系统，比如认证、权限等等，这类应用很容易买到，没有企业特点限制，不需要做太多的定制化。而支撑域则具有企业特性，但不具有通用性，例如数据代码类的数据字典等系统。

## 限界上下文

综合一下，我认为限界上下文的定义就是：用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等（通用语言）有一个确切的含义，没有二义性。这个边界定义了模型的适用范围，使团队所有成员能够明确地知道什么应该在模型中实现，什么不应该在模型中实现。

正如电商领域的商品一样，商品在不同的阶段有不同的术语，在销售阶段是商品，而在运输阶段则变成了货物。同样的一个东西，由于业务领域的不同，赋予了这些术语不同的涵义和职责边界，这个边界就可能会成为未来微服务设计的边界。

## 实体

1. 实体的业务形态：在战略设计时，实体是领域模型的一个重要对象。领域模型中的实体是多个属性、操作或行为的载体。
2. 实体的代码形态：在代码模型中，实体的表现形式是实体类，这个类包含了实体的属性和方法，通过这些方法实现实体自身的业务逻辑。
3. 实体的运行形态：实体以 DO（领域对象）的形式存在，每个实体对象都有唯一的 ID。我们可以对一个实体对象进行多次修改，修改后的数据和原来的数据可能会大不相同。但是，由于它们拥有相同的 ID，它们依然是同一个实体。
4. 实体的数据库形态：在领域模型映射到数据模型时，一个实体可能对应 0 个、1 个或者多个数据库持久化对象。大多数情况下实体与持久化对象是一对一。在某些场景中，有些实体只是暂驻静态内存的一个运行态实体，它不需要持久化。

## 值对象

值对象是 DDD 领域模型中的一个基础对象，它跟实体一样，都包含了若干个属性，它与实体一起构成聚合。

1. 值对象的业务形态。

本质上，实体是看得到、摸得着的实实在在的业务对象，实体具有业务属性、业务行为和业务逻辑。而值对象只是若干个属性的集合。

2. 值对象的代码形态。

我们看一下下面这段代码，person 这个实体有若干个单一属性的值对象，比如 Id、name 等属性；同时它也包含多个属性的值对象，比如地址 address。

3. 值对象的运行形态。

实体实例化后的 DO 对象的业务属性和业务行为非常丰富，但值对象实例化的对象则相对简单。

值对象嵌入到实体的话，有这样两种不同的数据格式，也可以说是两种方式，分别是属性嵌入的方式和序列化大对象的方式。

4. 值对象的数据库形态。

在领域建模时，我们可以将部分对象设计为值对象，保留对象的业务涵义，同时又减少了实体的数量；在数据建模时，我们可以将值对象嵌入实体，减少实体表的数量，简化数据库设计。

5. 值对象的优势和局限。

值对象采用序列化大对象的方法简化了数据库设计，减少了实体表的数量，可以简单、清晰地表达业务概念。这种设计方式虽然降低了数据库设计的复杂度，但却无法满足基于值对象的快速查询，会导致搜索值对象属性值变得异常困难。

## 实体和值对象的关系

DDD 提倡从领域模型设计出发，而不是先设计数据模型。

传统的数据模型设计通常是一个表对应一个实体，一个主表关联多个从表，当实体表太多的时候就很容易陷入无穷无尽的复杂的数据库设计，领域模型就很容易被数据模型绑架。可以说，值对象的诞生，在一定程度上，和实体是互补的。

有些场景中，地址会被某一实体引用，它只承担描述实体的作用，并且它的值只能整体替换，这时候你就可以将地址设计为值对象，比如收货地址。而在某些业务场景中，地址会被经常修改，地址是作为一个独立对象存在的，这时候它应该设计为实体，比如行政区划中的地址信息维护。

> 权威资料：《实现领域驱动设计》

## 聚合和聚合根

在 DDD 中，实体和值对象是很基础的领域对象。实体一般对应业务对象，它具有业务属性和业务行为；而值对象主要是属性集合，对实体的状态和特征进行描述。

























