> 来自极客时间《性能测试实战30讲》--高楼

# 07丨性能测试工具：如何录制脚本?

对于一个性能测试工具来说，如果能实现以下几大功能，那么就基本上就满足了性能测试工具的功能。

1. 录制或编写脚本功能
2. 参数化功能
3. 关联功能
4. 场景功能
5. 报告生成功能

今天，我们就来看下在性能测试工具中，如何录制脚本。

针对脚本，我们不仅要录制下来，还要了解录制的原理和录制完之后的脚本增强。不然，在场景中还是会遇到各种各样的问题。

**性能工具中的录制功能**

录制功能从原理上来说，分为两种：

1. 本地录制：通过截取并解析与服务器的交互协议包，生成脚本文件。比如说 LoadRunner 调起 IE 的时候，不用修改 IE 的代理设置，就可以直接抓取 HTTP 包，并通过自己的解析器解析成脚本。
2. 代理录制：通过代理服务器设置，转发客户端和服务器的交互协议包，生成脚本文件。JMeter 中的脚本录制功能就是这样做的。

这两者的不同点主要在于操作上。本地录制相对简单，但有些场景受限，比如说操作只能在某台服务器上，但是这台服务器又不允许安装工具；代理录制操作复杂一些，但可以满足更多的场景。

通过这张图，我们可以简单看到代理录制的逻辑：

![image-20211119222323225](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119222323.png)

1. 我们在 IP 为 2.2.2.2 上的主机上，打开一个代理程序，开 81 端口，所有到 81 端口的都转发到 1.1.1.1 的 80 端口。
2. 当 3.3.3.3 主机要访问 1.1.1.1 的的 80 端口，可以通过访问 2.2.2.2 的 81 端口进行转发。

> 这里需要你注意的是，代理是用来转发数据包的，并不是重定向哦。不管是在本机用代理，还是远程用代理，这个逻辑都是不会变的。

**JMeter 的录制功能**

首先打开 JMeter，添加一个线程组，再添加一个 HTTP(S) Test Script Recorder。

![image-20211119222552666](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119222552.png)

这里有几个关键点说明一下：

Target Controller：这里指定录制出的脚本要放到哪里去。如果你想把不同的脚本放到不同的线程组中去，在录制的时候就可以拆分开。

Grouping：分组，这个分组功能很实用。但是如何分组就和具体的目标相关了，这一点下面我们再细说。

点击 start 按钮时，会提示创建一个根 CA 证书。这个证书生成在 bin 目录中，文件名是： ApacheJMeterTemporaryRootCA.crt，七天有效期。这个证书将被用来客户端转发 HTTPS 的请求。与此同时，还有另一个证书在同目录中生成，名字是 proxyserver.jks，这是 JMeter 自己生成的根证书。

![image-20211119222814766](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119222814.png)

前面我们说到了，JMeter 是用代理的方式来录制的。如果服务端用了 SSL 证书，在代理时也要加 SSL 证书，那么代理录制的结构就会变成这样。

![image-20211119222858876](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119222858.png)

我们点击 ok 之后，就会出现这个界面。在这个界面中，只有两个配置项。

Prefix：请求名的前缀。

Create new transaction after request(ms)：一个请求完成之后，如果下一个请求超出了这里设置的时间间隔，就创建一个新的事务。

![image-20211119222958225](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119222958.png)

然后到主机上设置代理。

这里的代理设置，是在需要访问的客户机上。这个客户机，不一定是压力机所在的机器。这里的 localhost，也应该设置的是代理服务所在的主机 IP。

![image-20211119223125513](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119223125.png)

请注意，如果你要设置为录制 HTTPS，还需要做如下两步。

第一步是，浏览器代理要把 Secure Web Proxy(HTTPS) 选择上，同时填上相应的代理 IP 和端口，下图是 macOS 上的图示。

![image-20211119223202175](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119223202.png)

这时仍然录制不了 HTTPS 应用，访问时会出现如下提示：

![image-20211119223232402](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20211119223232.png)















