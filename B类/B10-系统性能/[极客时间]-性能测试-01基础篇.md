# 开篇词

在这个课程中，“性能测试”不仅仅包括测试，还包括分析和调优。

第一个模块：性能测试基础篇。

第二个模块：性能测试工具的实操。

第三个模块：性能分析。

第四个模块：性能测试分析过程。

# 01丨性能综述：性能测试的概念

**性能测试要有指标**

时间指标、容量指标、资源利用率指标。

**性能测试要有模型**

业务模型，比如说，我们有 100 种业务，只有 50 个业务需要有并发量，那就要把这些有并发的业务统计出来，哪个业务并发多，哪个业务并发少，做压力测试时就要控制好这样的比例。

监控模型，这个部分的监控，要有分层、分段的能力，要有全局监控、定向监控的能力。

**性能测试要有方案**

方案规定的内容中有几个关键点，分别是测试环境、测试数据、测试模型、性能指标、压力策略、准入准出和进度风险。

**性能测试要有预定的条件**

这里的条件包括软硬件环境、测试数据、测试执行策略、压力补偿等内容。要是展开来说，在场景执行之前，这些条件应该是确定的。

**性能测试中要有场景**

1. 基准性能场景
2. 容量性能场景
3. 稳定性性能场景
4. 异常性能场景

**性能测试中要有分析调优**

性能项目分以下几类：

- 新系统性能测试类

  这样的项目一般都会要求测试出系统的最大容量。

- 旧系统新版本性能测试类

  只要性能不下降，就可以根据历史数据推算容量。

- 新系统性能测试优化类

  这类系统不仅要测试出最大容量，还要求调优到最好。

对性能团队的职责定位有如下几种：

1. 性能验证
2. 性能测试
3. 性能测试 + 分析调做强

**性能测试要有结果报告**

在报告中写上 TPS、响应时间以及资源对比图。

**性能测试概念总结**

![image-20210528225408650](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210528225408.png)

# 02丨性能综述：TPS和响应时间之间是什么关系？

**系统性能描述图**

关于系统性能，有下面这样一张描述图：

![image-20210529213130760](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210529213130.png)

图中定义了三条曲线、三个区域、两个点以及三个状态描述。

三条曲线：使用率（U）、吞吐量曲线（X）、响应时间曲线（R）。

三个区域：轻负载区（Light Load）、重负载区（Heavy Load）、塌陷区（Buckle Zone）。

两个点：最优并发用户数（The Optimum Number of Consurrent Users）、最大并发用户数（The Maximum Number of Consurrent Users）。

三个状态描述：资源饱和（Resource Saturated）、吞吐下降（Throughput Falling）、用户受影响（End Users Effected）。

**TPS和响应时间**

![image-20210529215017916](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210529215017.png)

上图中蓝线表示 TPS，黄线表示响应时间。

在 TPS 增加的过程中，响应时间一开始会处在较低的状态，也就是在 A 点之前。

接着响应时间开始有些增加，直到业务可以承受的时间点 B，这时 TPS 仍然有增长的空间。

再接着增加压力，达到 C 点时，达到最大 TPS。我们再接着增加压力，响应时间接着增加，但 TPS 会有所下降。

> 这里并不是必然的，有些系统在队列上处理得很好，会保持稳定的 TPS，然后多出来的请求都被友好拒绝。

最后，D 点之后响应时间过长，达到了超时的程度。

在实际的性能测试中，基准性能场景也好，容量性能场景也好，都是需要递增的，而不是上来就用几百几千的线程。同时，递增也是要连续的，而不是 100 线程、200 线程、300 线程这样断开执行场景。

> 性能场景为什么要连续？而不是断开？
>
> 递增线程数可以记录每次的性能指标，画曲线对比分析，来观察指标变化的趋势，找出性能瓶颈以及服务器最大处理能力。

# 03丨性能指标：怎么理解TPS、QPS、RT、吞吐量这些性能指标？

性能测试行业常用的性能指标表示法。

| 简写       | 英文全称                           | 含义                                                         |
| ---------- | ---------------------------------- | ------------------------------------------------------------ |
| RT         | Response Time                      | 响应时间。通常我们说的响应时间，都是包括了Request Time和Response Time。 |
| HPS        | Hits Per Second                    | 每秒点击数                                                   |
| TPS        | Transactions Per Second            | 每秒事务数                                                   |
| QPS        | Queries Per Second                 | 在MySQL中指每秒SQL数                                         |
| RPS        | Requests Per Second                | 每秒请求数                                                   |
| CPS        | Codes Per Second                   | 在HTTP协议中，CPS偶有提及，指的是HTTP返回码每秒。            |
| PV         | Page View                          | 页面浏览量                                                   |
| UV         | Unique Visitor                     | 独立访问者                                                   |
| IP         | Internet Protocol                  | 本意是IP地址，在性能中一般指独立IP数                         |
| Throughput | /                                  | 吞吐量                                                       |
| IOPS       | Input/Output Operations Per Second | 通常描述磁盘                                                 |

**TPS**

TPS 是性能领域中一个关键的性能指标概念，它用来描述每秒事务数，可以反映出一个系统的处理能力。TPS 在不同的行业、不同的业务中定义的粒度也是不同的。所以不管你在哪里用 TPS，一定要有一个前提，就是所有相关的人都要知道你的 T 是如何定义的。

以下图为例：

![image-20210530215245305](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210530215245.png)

如果我们要单独测试接口 1、2、3，那 T 就是接口级的；如果我们要从用户的角度来下一 个订单，那 1、2、3 应该在一个 T 中，这就是业务级的了。

**RPS**

如果一个用户点击了一次，发出来 3 个 HTTP Request，调用了 2 次订单服务，调用了 2 次库存服务，调用了 1 次积分服务，那么这个 Request 该如何计算?

![image-20210530211539445](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210530211539.png)

如果要描述整体，最多算是有 3 个 RPS。如果从 HTTP 协议的角度去理解，那么 HTTP Request 算是一个比较准确的描述了，但它本身的定义并没有包含业务。如果赋予它业务的含义，那么用它来描述性能也是可以的。

**压力工具中的线程数（用户数）与 TPS**

“并发”这个概念是需要具体的指标来承载的。

你可以说，我的并发是 1000TPS，或者 1000RPS，或者 1000HPS。但不能说并发 1000 这样没有单位的词。

以下图为例，来描述线程数与 TPS。

![image-20210531220842593](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210531220842.png)

上图有 4 个并发线程，每个线程都可以在一秒内完成 4 个事务，所以总的 TPS 是 16。

那么用户数怎么来定义呢？一个系统如果有 1 万个用户在线，很多业务中，并发度都会低于 5%，甚至低于 1%。拿 5% 来计算，就是 
$$
10000 用户 * 5\%=500(TPS)
$$
注意这里是 TPS 而不是并发线程数。如果这时响应时间是 100ms，那显然并发线程数是
$$
500TPS / (1000ms / 100ms)=50(并发线程)
$$
通过这样简单的计算逻辑，我们就可以看出来用户数、线程数和 TPS 之间的关系了。

# 04丨JMeter和LoadRunner：要知道工具仅仅只是工具

**性能工程师学习的三个阶段**

- 性能工具学习阶段

工具只做两件事情，做脚本和发压力。

- 性能场景学习阶段

比如说压力策略，应该用一秒 Ramp up 10 个用户，还是 20 个用户，还是 100 个用户？这应该怎么判断呢?

- 性能分析学习阶段

怎么判断性能瓶颈在哪里？

**公司性能团队成长阶段**

- 性能团队初建

这时的团队，可以执行场景，可以拿出数据，但工作出的结果并不理想。

- 性能团队初成熟

到了这个阶段，团队已经可以应付版本的更迭带来的性能工作压力。

- 性能团队已成熟

能回答出以下问题：

1. 通过测试和分析优化之后，性能提升了多少?

   一个成熟的团队应该回答的是：提升了 10 倍，我们调优了什么什么。

2. 通过你的测试和分析优化之后，节省了多少成本?

   之前的版本用了 200 台机器，而通过我们的测试分析优化之后，只用到了 100 台机器。

**工具如何选择？**

工具只是一个压力发起者，工具应该如何用，完全取决于用的人，而不是工具本身。

没有一个工具可以直接告诉你瓶颈在哪里，能告诉你的只
是数据是什么。

对于企业来说，如果是一个需要支持每秒 100TPS 的企业内部业务系统，找一台 4C8G 的机器，就压得够了。如果是一个需要支持万级 TPS，可以自己搭建一套测试环境。

对个人来说呢，压测工具市场首选学习 JMeter，其次是 LoadRunner。

# 05丨指标关系：你知道并发用户数应该怎么算吗？

**什么是并发？**

并发包括”绝对并发”和“相对并发”这两个概念。绝对并发指的是同一时刻的并发数；相对并发指的是一个时间段内发生的事情。

![image-20210601231818489](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210601231818.png)

上图中的系统的绝对并发用户数是 4。如果描述 1 秒内的并发用户数，那就是 16。

> “绝对并发”这个概念，不管是用来描述硬件细化的层面，还是用来描述业务逻辑的层面，都是没什么意义的。

如何来描述上面的并发用户数呢？在这里我建议用 TPS 来承载“并发”这个概念。并发数是 16TPS，就是 1 秒内整个系统处理了 16 个事务。

**在线用户数怎么计算？**

那么新问题又来了，在线用户数和并发用户数应该如何算呢？下面我们接着来看示意图：

![image-20210601232708435](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210601232708.png)

如上图所示，总共有 32 个用户进入了系统，但是绿色的用户并没有任何动作，那么显然，在线用户数是 32 个，并发用户数是 16 个，这时的并发度就是 50%。

在一个系统中，通过把在线用户数据放到 Redis 这样的缓存服务器中。所以如果想知道在线的最大的用户数是多少，直接拿缓存的内存来算就可以了。

假设一个用户进入系统之后，需要用 10k 内存来维护一个用户的信息，那么 10G 的内存就能 hold 住 1,048,576 个用户的数据，这就是最大在线用户数了。在实际的项目中，我们还会将超时放在一起来考虑。

**并发用户数怎么计算？**

要想计算并发用户和在线用户数之间的关系，就要计算出并发度。我们通过一个示意图来说明：

![image-20210601234326518](https://gitee.com/yanglu_u/ImgRepository/raw/master/images/20210601234326.png)

