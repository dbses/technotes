# 开篇词 | 阅读Redis源码能给你带来什么？

**会用 Redis 不就行了，为啥要读源码呢？**

我遇到过不少做开发或是运维的团队，他们在使用或运维 Redis 时，经常会面临 Redis 性能变差、Redis 实例故障等问题，而这些问题都会影响到业务应用的运行。

如果你不了解 Redis 源码层面的实现原理，那不管你是在实际开发中排查问题故障点，还是在技术面试中快速拆解问题的套路，都可能会受到阻碍。

另外，学习源码除了能帮助我们掌握 Redis 的设计细节，还能带来以下三点收获。

第一，从原理到源码，掌握学习主动权。

一旦我们养成阅读源码的习惯，再遇到问题时，我们就会“条件反射”式地从源码中去寻找答案。而且在 Redis 文档未及时更新的情况下，通过源码可以提前了解 Redis 新特性。

比如，Redis 在 2020 年 5 月份推出了 6.0 版本，在该版本中，Redis 实现了多 IO 线程机制。如果我们养成了阅读 Redis 源码的习惯，就可以尽早地了解 Redis 6.0 中多 IO 线程的具体实现，并评估其可用性。

第二，学习良好的编程规范和技巧，写出高质量的代码。

第三，举一反三，学习计算机系统设计思想，实现职业能力进阶。

我画了下面这张图，显示了通过阅读 Redis 源码，可以学习和掌握到的计算机系统设计思想。

![image-20221221225018722](https://technotes.oss-cn-shenzhen.aliyuncs.com/2022/202212212250809.png)

**如何正确学习 Redis 源码？**

高效阅读代码的第一个要点，是要先从整体上掌握源码的结构。所以，对于阅读 Redis 源码来说，我们就需要先形成一幅 Redis 源码的全景图，如下所示。

![image-20221221225152684](https://technotes.oss-cn-shenzhen.aliyuncs.com/2022/202212212251723.png)

有了这张图以后，我们就可以根据自己的学习需求，查找到所要学习的代码文件。然后，我们再根据 Redis 不同的功能特性，分线条学习每个功能特性上涉及的关键技术和设计思想。

高效阅读代码的第二个要点，是一定要有目标牵引和原理支撑。

Redis 的功能模块很多，每个功能模块的实现也比较复杂，我们在阅读代码前一定要明确想要了解的目标，比如是想了解某个数据结构，还是想要了解主从复制的流程。

在确定目标后，我们还需要对相应的原理有所了解，然后再开始阅读源码。这是因为源码是原理的体现，如果对 Redis 功能的基本原理不了解，直接阅读源码，就难于理解代码逻辑，增加了代码阅读的难度。

高效阅读代码的第三个要点，是要做到先主线逻辑再分支细节。

虽然说源码是原理的体现，但是和原理相比，源码通常会考虑系统运行时的各种情况和细节。

我们在阅读代码时一定要先把功能模块的主线逻辑梳理出来，具体来说，就是先把代码执行路径了解清楚，其中的分支做好标记，不用一开始就逐行阅读。等主线逻辑清楚后，我们再学习不同分支的处理。

比如，我们在阅读 Redis 事件驱动处理框架代码时，就需要在代码中先把事件处理流程的主要步骤梳理出来，包括创建事件、监听事件、启动事件处理循环。然后，我们再去了解事件创建、监听和处理的各种细节。这样一来，代码阅读就能更加高效了。

**这门课程是怎样设计的？**

- 数据结构：你将学习到 Redis 主要数据结构的设计思想和实现，包括字符串的实现方法、内存紧凑型结构的设计、哈希表性能优化设计，以及 ziplist、quicklist、listpack、跳表的设计与实现等。
- 网络通信与执行模型：你将掌握 Redis server 的启动流程、高性能网络通信设计与实现、事件驱动框架的设计与实现、Redis 线程类型的设计和优化等。
- 缓存：你将了解常见缓存替换算法如何从原理转变为代码。可靠性保证：你将掌握 RDB、AOF 的具体实现，分布式系统中 Raft 一致性协议的设计实现，故障切换的关键代码实现等。
- 切片集群：你将学习到 Redis 切片集群中关键机制的设计与实现，包括 Gossip 通信协议、请求重定向、数据迁移等

# 01 | 带你快速攻略Redis源码的整体架构



**Redis 目录结构**

那么对于 Redis 来说，在它的源码总目录下，一共包含了 deps、src、tests、utils 四个子目录，这四个子目录分别对应了 Redis 中发挥不同作用的代码。

**Redis 功能模块与源码对应**



**服务器实例**



**数据库数据类型与操作**



**高可靠性和高可扩展性**

- 数据持久化实现
- 主从复制功能实现

**辅助功能**



# 02 | 键值对中字符串的实现，用char*还是结构体？



**为什么 Redis 不用 char*？**

- char* 的结构设计



- 操作函数复杂度



综合以上在 C 语言中使用 char* 实现字符串的两大不足之处以后，我们现在就需要 找到新的实现字符串的方式了。所以接下来，我们就来学习下，Redis 是如何对字符串的 实现进行设计考虑的。

**SDS 的设计思想**

- SDS 结构设计

 

- SDS 操作效率



**紧凑型字符串结构的编程技巧**



# 03 | 如何实现一个性能优异的Hash表？



**Redis 如何实现链式哈希？**

- 什么是哈希冲突？

那么我们该如何解决哈希冲突呢？可以考虑使用以下两种解决方案：

第一种方案，就是我接下来要给你介绍的链式哈希。这里你需要先知道，链式哈希的链不能太长，否则会降低 Hash 表性能。

第二种方案，就是当链式哈希的链长达到一定长度时，我们可以使用 rehash。不过，执行 rehash 本身开销比较大，所以就需要采用我稍后会给你介绍的渐进式 rehash 设 计。

- 链式哈希如何设计与实现？

在 dict.h 文件中.。

```c
typedef struct dictht {
    dictEntry **table; //二维数组
    unsigned long size; //Hash表大小
    unsigned long sizemask;
    unsigned long used;
} dictht;
```

不过，链式哈希也存在局限性，那就是随着链表长度的增加，Hash 表在一个位置上查询哈希项的耗时就会增加，从而增加了 Hash 表的整体查询时间，这样也会导致 Hash 表的性能下降。

**Redis 如何实现 rehash？**



**什么时候触发 rehash？**

# 04 | 内存友好的数据结构该如何细化设计？



# 06 | 从ziplist到quicklist，再到listpack的启发















































































